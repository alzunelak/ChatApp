<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calls</title>
<style>
body {
  font-family: Arial;
  margin: 0;
  padding: 0;
  background: #f5f5f5;
}
.main-content {
  padding: 20px;
  min-height: 70vh;
}
.call-item {
  padding: 10px;
  background: #fff;
  margin: 5px 0;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.call-item-left {
  display: flex;
  align-items: center;
}
.call-item img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-right: 10px;
}
.call-buttons button {
  margin-left: 5px;
  padding: 5px 10px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: #fff;
}
.call-buttons .audio-btn { background-color: #4CAF50; }
.call-buttons .video-btn { background-color: #2196F3; }
.call-status {
  font-size: 12px;
  margin-left: 10px;
}

/* Status colors */
.call-status.missed { color: #e74c3c; }      /* red for missed */
.call-status.declined { color: #555; }       /* gray for declined */
.call-status.accepted { color: #4CAF50; }    /* green for accepted */

/* Overlay for dimming background */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  z-index: 9998;
}

/* Incoming call popup */
.incoming-call {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 15px rgba(0,0,0,0.3);
  z-index: 9999;
  display: none;
}
.incoming-call img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin-bottom: 10px;
}
.incoming-call h3 {
  margin: 10px 0;
}
.incoming-call button {
  margin: 5px;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #fff;
  font-size: 14px;
}
.accept-btn { background-color: #4CAF50; }
.decline-btn { background-color: #e74c3c; }
</style>
</head>
<body>

<div class="main-content" id="mainContent"></div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Incoming call popup -->
<div class="incoming-call" id="incomingCallPopup">
  <img id="incomingProfile" src="default-profile.png" alt="Profile">
  <h3 id="incomingName">Friend</h3>
  <p id="incomingType">Incoming Call...</p>
  <button class="accept-btn" id="acceptIncoming">Accept</button>
  <button class="decline-btn" id="declineIncoming">Decline</button>
</div>

<audio id="ringTone" loop>
  <source src="ringtone.mp3" type="audio/mpeg">
</audio>

<script>
const friends = JSON.parse(localStorage.getItem('friends')||'[]');
const mainContent = document.getElementById('mainContent');
const ringTone = document.getElementById('ringTone');
const incomingPopup = document.getElementById('incomingCallPopup');
const incomingProfile = document.getElementById('incomingProfile');
const incomingName = document.getElementById('incomingName');
const incomingType = document.getElementById('incomingType');
const acceptBtn = document.getElementById('acceptIncoming');
const declineBtn = document.getElementById('declineIncoming');
const overlay = document.getElementById('overlay');

let callTimeout;
let currentCallFriend = null;
let statusMap = {};

if(friends.length === 0){
  mainContent.innerHTML = "<div>No calls yet</div>";
}else{
  friends.forEach(f => {
    const div = document.createElement('div');
    div.className = 'call-item';

    div.innerHTML = `
      <div class="call-item-left">
        <img src="${f.profile || 'default-profile.png'}" alt="Profile">
        <span>${f.name}</span>
        <span class="call-status" id="status-${f.name.replace(/\s+/g,'')}"></span>
      </div>
      <div class="call-buttons">
        <button class="audio-btn">Call</button>
        <button class="video-btn">Video</button>
      </div>
    `;

    const audioBtn = div.querySelector('.audio-btn');
    const videoBtn = div.querySelector('.video-btn');
    const statusEl = div.querySelector('.call-status');
    statusMap[f.name] = statusEl;

    function startCall(type){
      statusEl.innerText = "Calling...";
      ringTone.play().catch(()=>console.log("Autoplay blocked until user interaction"));
      setTimeout(() => {
        ringTone.pause();
        ringTone.currentTime = 0;
        if(type==='audio'){
          window.location.href = `audio-call.html?friend=${encodeURIComponent(f.name)}`;
        } else {
          window.location.href = `video-call.html?friend=${encodeURIComponent(f.name)}`;
        }
      }, 2000);
    }

    audioBtn.onclick = () => startCall('audio');
    videoBtn.onclick = () => startCall('video');

    mainContent.appendChild(div);
  });
}

function showIncomingPopup(friend){
  currentCallFriend = friend;
  incomingProfile.src = friend.profile || 'default-profile.png';
  incomingName.innerText = friend.name;
  const callType = Math.random() < 0.5 ? 'Audio' : 'Video';
  incomingType.innerText = `Incoming ${callType} Call...`;

  incomingPopup.style.display = 'block';
  overlay.style.display = 'block';

  ringTone.play().catch(()=>console.log("Autoplay blocked, will play after click"));

  // auto-decline after 25s
  callTimeout = setTimeout(() => {
    hideIncomingPopup();
    if(statusMap[friend.name]){
      statusMap[friend.name].innerText = "Missed Call";
      statusMap[friend.name].className = "call-status missed";
    }
  }, 25000);

  // Accept
  acceptBtn.onclick = () => {
    hideIncomingPopup();
    if(statusMap[friend.name]){
      statusMap[friend.name].innerText = "Call Accepted";
      statusMap[friend.name].className = "call-status accepted";
    }
    if(callType === 'Audio'){
      window.location.href = `audio-call.html?friend=${encodeURIComponent(friend.name)}`;
    } else {
      window.location.href = `video-call.html?friend=${encodeURIComponent(friend.name)}`;
    }
  };

  // Decline / overlay
  const declineFn = () => {
    hideIncomingPopup();
    if(statusMap[friend.name]){
      statusMap[friend.name].innerText = "Call Declined";
      statusMap[friend.name].className = "call-status declined";
    }
  };

  declineBtn.onclick = declineFn;
  overlay.onclick = declineFn;
}

function hideIncomingPopup(){
  incomingPopup.style.display = 'none';
  overlay.style.display = 'none';
  ringTone.pause();
  ringTone.currentTime = 0;
  clearTimeout(callTimeout);
}

// Simulate incoming calls
function simulateIncomingCall(){
  if(friends.length === 0) return;
  const randomFriend = friends[Math.floor(Math.random() * friends.length)];
  showIncomingPopup(randomFriend);
}

// First simulated call after 3s
setTimeout(simulateIncomingCall, 3000);
// Every 15s
setInterval(simulateIncomingCall, 15000);
</script>

</body>
</html>
