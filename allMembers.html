<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Members</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  #groupMembersList { display: flex; flex-wrap: wrap; gap: 10px; }
  .memberBox { 
    padding: 10px 15px; 
    background: #fff; 
    border: 1px solid #ccc; 
    border-radius: 5px; 
    position: relative; 
    cursor: pointer; 
    min-width: 120px;
  }
  .popupMenu { 
    position: absolute; 
    top: 30px; 
    right: 0; 
    background: #eee; 
    border: 1px solid #ccc; 
    border-radius: 5px; 
    display: none; 
    z-index: 10;
  }
  .menuItem { 
    padding: 5px 10px; 
    cursor: pointer; 
  }
  .menuItem:hover { background: #128C7E; color: #fff; }
</style>
</head>
<body>

<h2>All Members</h2>
<div id="memberCount"></div>
<div id="groupMembersList"></div>

<script>
  // Fetch from localStorage
  let groups = JSON.parse(localStorage.getItem("groups")) || [];
  let currentGroupIndex = parseInt(localStorage.getItem("currentGroupIndex")) || 0;
  let currentGroup = groups[currentGroupIndex] || { members: [], blocked: [] };

  let currentGroupMembers = currentGroup.members.map(m => m.name);
  let blockedMembers = currentGroup.blocked || [];

  function renderAllMembers() {
    const membersDiv = document.getElementById("groupMembersList");
    membersDiv.innerHTML = "";

    const activeMembers = currentGroupMembers.filter(m => !blockedMembers.includes(m));

    if (activeMembers.length === 0) {
      const div = document.createElement("div");
      div.textContent = "No active members";
      div.style.fontStyle = "italic";
      div.style.color = "#555";
      membersDiv.appendChild(div);
    } else {
      activeMembers.forEach(name => {
        const div = document.createElement("div");
        div.className = "memberBox";
        div.textContent = name;

        // Popup menu
        const popup = document.createElement("div");
        popup.className = "popupMenu";
        popup.innerHTML = `
          <div class="menuItem messageItem">Message</div>
          <div class="menuItem blockItem">Block</div>
        `;
        div.appendChild(popup);

        div.addEventListener("click", (e) => {
          e.stopPropagation();
          document.querySelectorAll(".memberBox .popupMenu").forEach(p => p.style.display = "none");
          popup.style.display = "block";
        });

        popup.querySelector(".messageItem").addEventListener("click", () => {
          window.location.href = "chat.html?user=" + encodeURIComponent(name);
        });

        popup.querySelector(".blockItem").addEventListener("click", () => {
          if (!blockedMembers.includes(name) && confirm(`Block ${name}?`)) {
            blockedMembers.push(name);
            currentGroup.blocked = blockedMembers;
            groups[currentGroupIndex] = currentGroup;
            localStorage.setItem("groups", JSON.stringify(groups));
            renderAllMembers();
          }
          popup.style.display = "none";
        });

        membersDiv.appendChild(div);
      });
    }

    // Update count
    document.getElementById("memberCount").textContent = `${activeMembers.length} Member${activeMembers.length !== 1 ? "s" : ""}`;
  }

  // Close all popups when clicking outside
  document.addEventListener("click", () => {
    document.querySelectorAll(".memberBox .popupMenu").forEach(p => p.style.display = "none");
  });

  // Initial render
  renderAllMembers();
</script>

</body>
</html>
