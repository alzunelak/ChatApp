<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat with Friend</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body {margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#fff;color:#000;height:100vh;display:flex;flex-direction:column;}
  #chatPage,#friendInfoPage{display:flex;flex-direction:column;flex:1;}
  
  /* Chat Header */
  #chatHeader{display:flex;flex-direction:column;align-items:center;background:#075E54;color:white;padding:15px;position:sticky;top:0;z-index:10;cursor:pointer;}
  #chatHeader .topRow{width:100%;display:flex;align-items:center;}
  #chatHeader .topRow i{cursor:pointer;font-size:20px;margin-right:10px;}
  #chatHeader img{width:70px;height:70px;border-radius:50%;object-fit:cover;margin:10px 0;}
  #chatHeader span{display:block;text-align:center;}
  #chatHeader .friendName{font-size:18px;font-weight:bold;}
  #chatHeader .friendStatus{font-size:14px;color:#d2f5e3;}
  
  /* Chat box */
  #chatBox{flex:1;overflow-y:auto;padding:10px;}
  .msg{max-width:70%;padding:10px 14px;margin:5px 0;border-radius:18px;background:#f1f1f1;align-self:flex-start;position:relative;word-break:break-word;}
  .msg.self{background:#dcf8c6;align-self:flex-end;}
  .msg .meta{font-size:10px;color:#999;text-align:right;}
  
  /* Input area */
  #inputArea{display:flex;align-items:center;padding:10px;background:#f0f0f0;}
  #msgInput{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;outline:none;}
  #sendBtn{margin-left:5px;background:#25D366;color:white;border:none;padding:0 12px;border-radius:50%;font-size:22px;cursor:pointer;}
  
  /* Friend Info Page */
  #friendInfoPage{display:none;flex:1;overflow-y:auto;}
  .infoHeader{display:flex;align-items:center;gap:10px;padding:10px;background:#075E54;color:white;}
  .infoHeader i{cursor:pointer;font-size:20px;}
  .infoHeader img{width:70px;height:70px;border-radius:50%;object-fit:cover;margin-left:10px;}
  .infoHeader .infoName{font-size:18px;font-weight:bold;}
  .infoHeader .infoStatus{font-size:14px;color:#d2f5e3;}
  
  .actionButtons{display:flex;justify-content:space-around;margin:10px 0;padding:10px;}
  .actionButtons .btn{flex:1;margin:0 5px;background:#fff;border-radius:10px;padding:15px;display:flex;flex-direction:column;align-items:center;cursor:pointer;}
  .actionButtons .btn i{font-size:24px;color:#075E54;}
  .actionButtons .btn span{margin-top:5px;font-size:14px;color:#075E54;}
  
  .settingsContainer button{display:flex;align-items:center;gap:10px;width:100%;padding:12px;border:none;background:#f1f1f1;border-radius:8px;margin-bottom:5px;cursor:pointer;}
  .actionBox button{display:flex;align-items:center;gap:10px;width:100%;padding:12px;border:none;background:none;color:#f44336;cursor:pointer;margin-bottom:5px;}
</style>
</head>
<body>

<!-- CHAT PAGE -->
<div id="chatPage">
  <div id="chatHeader">
    <img id="chatFriendPhoto" src="default-profile.png">
    <span class="friendName" id="chatFriendName">Friend</span>
    <span class="friendStatus" id="chatFriendStatus">Offline</span>
  </div>

  <div id="chatBox"></div>

  <div id="inputArea">
    <input id="msgInput" placeholder="Type a message...">
    <button id="sendBtn">âž¡</button>
  </div>
</div>

<!-- FRIEND INFO PAGE -->
<div id="friendInfoPage">
  <div class="infoHeader">
    <i class="fa-solid fa-arrow-left" onclick="backToChat()"></i>
    <img id="infoFriendPhoto" src="default-profile.png">
    <div style="display:flex;flex-direction:column;">
      <span class="infoName" id="infoFriendName">Friend</span>
      <span class="infoStatus" id="infoFriendStatus">Offline</span>
    </div>
  </div>

  <div class="actionButtons">
    <div class="btn"><i class="fa-solid fa-video"></i><span>Video Call</span></div>
    <div class="btn"><i class="fa-solid fa-phone"></i><span>Audio Call</span></div>
    <div class="btn"><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></div>
  </div>

  <div class="settingsContainer">
    <button><i class="fa-solid fa-lock"></i> End-to-End Encryption</button>
    <button><i class="fa-solid fa-network-wired"></i> Mesh Network Form</button>
    <button><i class="fa-solid fa-paint-roller"></i> Chat Color & Wallpaper</button>
    <button><i class="fa-solid fa-shield"></i> Advanced Chat Privacy</button>
  </div>

  <div class="actionBox">
    <button><i class="fa-solid fa-ban"></i> Block User</button>
    <button><i class="fa-solid fa-flag"></i> Report User</button>
  </div>
</div>

<script>
  // --- Friend Info ---
  const friendsList = JSON.parse(localStorage.getItem('friends') || '[]');
  const params = new URLSearchParams(window.location.search);
  const friendParam = params.get("friend") ? decodeURIComponent(params.get("friend")) : "Friend";

  const friendObj = friendsList.find(f => f.name === friendParam);
  const friendData = {
    name: friendObj ? friendObj.name : friendParam,
    photo: friendObj && friendObj.profile ? friendObj.profile : "default-profile.png",
    online: friendObj ? friendObj.online : false
  };

  // Chat header
  const chatFriendNameEl = document.getElementById("chatFriendName");
  const chatFriendPhotoEl = document.getElementById("chatFriendPhoto");
  const chatFriendStatusEl = document.getElementById("chatFriendStatus");

  chatFriendNameEl.textContent = friendData.name;
  chatFriendPhotoEl.src = friendData.photo;
  chatFriendPhotoEl.onerror = () => { chatFriendPhotoEl.src = "default-profile.png"; };
  chatFriendStatusEl.textContent = friendData.online ? "Online" : "Offline";
  chatFriendStatusEl.style.color = friendData.online ? "#d2f5e3" : "#ccc";

  // Friend Info page
  document.getElementById("infoFriendName").textContent = friendData.name;
  document.getElementById("infoFriendPhoto").src = friendData.photo;
  document.getElementById("infoFriendPhoto").onerror = () => { document.getElementById("infoFriendPhoto").src = "default-profile.png"; };
  document.getElementById("infoFriendStatus").textContent = friendData.online ? "Online" : "Offline";
  document.getElementById("infoFriendStatus").style.color = friendData.online ? "#d2f5e3" : "#ccc";

  // --- Chat Logic ---
  const myId = localStorage.getItem("userId") || ("guest_" + Math.floor(Math.random()*100000));
  const myName = localStorage.getItem("username") || "Me";
  const chatBox = document.getElementById("chatBox");
  const msgInput = document.getElementById("msgInput");
  let messages = JSON.parse(localStorage.getItem(`chat_${friendData.name}`) || "[]");

  function renderMessages(){
    chatBox.innerHTML="";
    messages.forEach(m=>{
      const div=document.createElement("div");
      div.className="msg"+(m.senderId===myId?" self":"");
      div.innerHTML=`<b>${m.senderName}:</b> ${m.text} <div class="meta">${m.time}</div>`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  msgInput.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const txt = msgInput.value.trim();
      if(!txt) return;
      const msg = {id:Date.now(), senderId:myId, senderName:myName, text:txt, time:new Date().toLocaleTimeString()};
      messages.push(msg);
      localStorage.setItem(`chat_${friendData.name}`, JSON.stringify(messages));
      msgInput.value = "";
      renderMessages();
    }
  });

  renderMessages();

  // Navigate to Friend Info
  chatFriendPhotoEl.onclick = openFriendInfo;
  chatFriendNameEl.onclick = openFriendInfo;

  function openFriendInfo(){
    document.getElementById("chatPage").style.display="none";
    document.getElementById("friendInfoPage").style.display="flex";
  }

  function backToChat(){
    document.getElementById("friendInfoPage").style.display="none";
    document.getElementById("chatPage").style.display="flex";
  }
</script>
</body>
</html>
