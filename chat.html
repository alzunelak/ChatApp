<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body {font-family:Arial;margin:0;padding:0;background:#e5ddd5;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.chat-header {background:#075E54;color:white;padding:10px 15px;font-size:18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.chat-header-left {display:flex;align-items:center;}
.chat-header-left img {width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;}
.chat-header-right button {background:none;border:none;color:white;font-size:20px;margin-left:10px;cursor:pointer;}
.chat-messages {flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;}
.message-container {display:flex;margin:5px 0;align-items:flex-end;position:relative;}
.message-container.sent {justify-content:flex-end;}
.message-container.received {justify-content:flex-start;}
.message-container.received img {width:30px;height:30px;border-radius:50%;margin-right:5px;object-fit:cover;}
.message {max-width:70%;padding:8px 12px;border-radius:18px;position:relative;word-wrap:break-word;cursor:pointer;}
.sent .message {background:#dcf8c6;align-self:flex-end;}
.received .message {background:white;align-self:flex-start;}
.timestamp {font-size:10px;color:#888;margin-top:2px;text-align:right;}
.chat-input {display:flex;padding:10px;background:#f0f0f0;align-items:center;position:sticky;bottom:0;z-index:10;}
.chat-input input {flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;margin-right:5px;}
.chat-input button {padding:0 12px;border:none;background:#25D366;color:white;border-radius:50%;font-size:22px;cursor:pointer;margin-left:5px;}
.msg-options {position:absolute;background:white;padding:5px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:none;z-index:100;}
.msg-options button {border:none;background:none;color:#075E54;padding:5px 10px;cursor:pointer;}
</style>
</head>
<body>

<div class="chat-header">
  <div class="chat-header-left">
    <img id="friendProfile" src="default-profile.png">
    <span id="friendName">Friend</span>
  </div>
  <div class="chat-header-right">
    <button id="audioCallBtn">ðŸŽ¤</button>
    <button id="videoCallBtn">ðŸ“¹</button>
    <button id="blockBtn">ðŸš«</button>
  </div>
</div>

<div class="chat-messages" id="chatMessages"></div>

<div class="chat-input">
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button id="sendBtn">âž¡</button>
</div>

<script>
// --- Setup ---
const params = new URLSearchParams(window.location.search);
const friend = params.get('friend') ? decodeURIComponent(params.get('friend')) : 'John Doe';
const profile = params.get('profile') ? decodeURIComponent(params.get('profile')) : 'default-profile.png';
document.getElementById('friendName').innerText = friend;
document.getElementById('friendProfile').src = profile;

// --- Chat Storage ---
function getChat(){ return JSON.parse(localStorage.getItem(`chat_${friend}`)||'[]'); }
function saveChat(messages){ localStorage.setItem(`chat_${friend}`, JSON.stringify(messages)); }
function formatTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

// --- Load Chat ---
const chatContainer = document.getElementById('chatMessages');
function loadChat(){
  chatContainer.innerHTML = '';
  getChat().forEach((msg, i)=>{
    const container = document.createElement('div');
    container.className = 'message-container ' + (msg.sender==='me'?'sent':'received');

    if(msg.sender==='me'){
      const div = document.createElement('div'); div.className='message'; div.innerText = msg.text;
      const ts = document.createElement('div'); ts.className='timestamp'; ts.innerText = msg.time;
      div.appendChild(ts);
      container.appendChild(div);
    } else {
      const img = document.createElement('img'); img.src = profile;
      const div = document.createElement('div'); div.className='message'; div.innerText = msg.text;
      const ts = document.createElement('div'); ts.className='timestamp'; ts.innerText = msg.time;
      div.appendChild(ts);
      container.appendChild(img);
      container.appendChild(div);
    }

    // Attach message options
    attachMessageOptions(container, i);
    chatContainer.appendChild(container);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// --- Send Message ---
const sendBtn = document.getElementById('sendBtn');
const input = document.getElementById('messageInput');
sendBtn.addEventListener('click', ()=>{ sendMessage(); });
input.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  const messages = getChat();
  messages.push({sender:'me', text:text, time:formatTime()});
  saveChat(messages);
  input.value='';
  loadChat();
}

// --- Message Options (Delete/Edit) ---
function attachMessageOptions(msgDiv,index){
  const msgContent = msgDiv.querySelector('.message');
  msgContent.addEventListener('contextmenu', e=>{ e.preventDefault(); showOptions(msgDiv,index); });
  let pressTimer;
  msgContent.addEventListener('touchstart', e=>{ pressTimer = setTimeout(()=>showOptions(msgDiv,index),600); });
  msgContent.addEventListener('touchend', e=>clearTimeout(pressTimer));
  msgContent.addEventListener('touchmove', e=>clearTimeout(pressTimer));
}

function showOptions(msgDiv,index){
  document.querySelectorAll('.msg-options').forEach(o=>o.remove());
  const options = document.createElement('div'); options.className='msg-options';
  const messages = getChat();

  // Delete for everyone
  const delAll = document.createElement('button'); delAll.innerText='Delete for everyone';
  delAll.onclick = ()=>{
    messages.splice(index,1);
    saveChat(messages);
    loadChat();
    options.remove();
  };

  // Delete for me
  const delMe = document.createElement('button'); delMe.innerText='Delete for me';
  delMe.onclick = ()=>{
    if(messages[index].sender==='me'){ messages.splice(index,1); saveChat(messages); loadChat(); }
    else alert('Cannot delete others message for you.');
    options.remove();
  };

  // Edit
  const editBtn = document.createElement('button'); editBtn.innerText='Edit';
  editBtn.onclick = ()=>{
    if(messages[index].sender==='me'){
      let newText = prompt('Edit your message:', messages[index].text);
      if(newText!==null && newText.trim()!==''){
        messages[index].text = newText;
        saveChat(messages);
        loadChat();
      }
    } else alert('Cannot edit others message.');
    options.remove();
  };

  options.appendChild(delAll);
  options.appendChild(delMe);
  options.appendChild(editBtn);

  const rect = msgDiv.getBoundingClientRect();
  options.style.top = rect.top + 'px';
  options.style.left = rect.left + 'px';
  document.body.appendChild(options);

  document.addEventListener('click', function hide(e){
    if(!options.contains(e.target)){ options.remove(); document.removeEventListener('click',hide); }
  });
}

// --- Initial load ---
loadChat();
</script>
</body>
</html>
