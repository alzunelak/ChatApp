<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body {font-family:Arial;margin:0;padding:0;background:#e5ddd5;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.chat-header {background:#075E54;color:white;padding:10px 15px;font-size:18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.chat-header-left {display:flex;align-items:center;}
.chat-header-left img {width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;}
.chat-header-right button {background:none;border:none;color:white;font-size:20px;margin-left:10px;cursor:pointer;}
.chat-messages {flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;}
.message-container {display:flex;margin:5px 0;align-items:flex-end;position:relative;}
.message-container.sent {justify-content:flex-end;}
.message-container.received {justify-content:flex-start;}
.message-container.received img {width:30px;height:30px;border-radius:50%;margin-right:5px;object-fit:cover;}
.message {max-width:70%;padding:8px 12px;border-radius:18px;position:relative;word-wrap:break-word;cursor:pointer;}
.sent .message {background:#dcf8c6;align-self:flex-end;}
.received .message {background:white;align-self:flex-start;}
.timestamp {font-size:10px;color:#888;margin-top:2px;text-align:right;}
.chat-input {display:flex;padding:10px;background:#f0f0f0;align-items:center;position:sticky;bottom:0;z-index:10;}
.chat-input input {flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;margin-right:5px;}
.chat-input button {padding:0 12px;border:none;background:#25D366;color:white;border-radius:50%;font-size:22px;cursor:pointer;margin-left:5px;}
.preview{max-width:200px;border-radius:10px;margin-top:5px;}

/* Attachment menu styles */
.circle-btn {width:40px;height:40px;border-radius:50%;border:none;background:#25D366;color:white;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:5px;}
.attachment-menu {position:absolute;bottom:60px;left:10px;display:none;flex-direction:column;gap:10px;}
.attachment-btn {width:50px;height:50px;border-radius:50%;border:none;background:#075E54;color:white;font-size:22px;cursor:pointer;}

/* Delete popup styles */
#deletePopup {position:absolute;display:none;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:100;padding:5px;}
#deletePopup button {background:none;border:none;padding:5px 10px;cursor:pointer;width:100%;text-align:left;}
#deletePopup button:hover {background:#f0f0f0;}
</style>
</head>
<body>

<div class="chat-header">
  <div class="chat-header-left">
    <img id="friendProfile" src="default-profile.png">
    <span id="friendName">Friend</span>
  </div>
  <div class="chat-header-right">
    <button id="blockBtn">üö´</button>
  </div>
</div>

<div class="chat-messages" id="chatMessages"></div>

<div class="chat-input">
  <button id="attachmentToggle" class="circle-btn">+</button>
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button id="sendBtn">‚û°</button>
</div>

<div id="attachmentMenu" class="attachment-menu">
  <button class="attachment-btn" id="sendFileBtn">üìÑ</button>
  <button class="attachment-btn" id="takePhotoBtn">üì∏</button>
  <button class="attachment-btn" id="takeVideoBtn">üé•</button>
  <button class="attachment-btn" id="sendLocationBtn">üìç</button>
</div>

<!-- Delete Popup -->
<div id="deletePopup">
  <button id="deleteForMeBtn">üóë Delete for me</button>
  <button id="deleteForEveryoneBtn">‚ùå Delete for everyone</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// --- User Profile ---
const myName = localStorage.getItem("username") || "Me";
const myPic = localStorage.getItem("profilePic") || "default-profile.png";
const myId  = localStorage.getItem("userId") || ("guest_" + Math.floor(Math.random()*100000));

// --- Friend Info ---
const params = new URLSearchParams(window.location.search);
const friend = params.get('friend') ? decodeURIComponent(params.get('friend')) : 'John Doe';
const friendsList = JSON.parse(localStorage.getItem('friends') || '[]');
const friendObj = friendsList.find(f => f.name === friend);
const friendName = friendObj ? friendObj.name : friend;
const friendProfile = friendObj && friendObj.profile ? friendObj.profile : 'default-profile.png';

// Set header
const friendNameEl = document.getElementById('friendName');
const friendProfileEl = document.getElementById('friendProfile');
friendNameEl.innerText = friendName;
friendProfileEl.src = friendProfile;
friendProfileEl.onerror = () => { friendProfileEl.src = 'default-profile.png'; }

// --- Socket.IO connection ---
const socket = io("http://localhost:3000");
socket.emit("register", myName);

// --- Chat Storage ---
function getChat(){ return JSON.parse(localStorage.getItem(`chat_${friend}`)||'[]'); }
function saveChat(messages){ localStorage.setItem(`chat_${friend}`, JSON.stringify(messages)); }
function formatTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

// --- Blocked Users ---
function isBlocked(friendName){
  const blockedUsers = JSON.parse(localStorage.getItem("blockedUsers")||"[]");
  return blockedUsers.includes(friendName);
}

const blockBtn = document.getElementById('blockBtn');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

function updateInputState(){
  if(isBlocked(friend)){
    input.disabled = true;
    input.placeholder = "You have blocked this user.";
    sendBtn.disabled = true;
  } else {
    input.disabled = false;
    input.placeholder = "Type a message...";
    sendBtn.disabled = false;
  }
}

blockBtn.addEventListener('click', () => {
  let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers") || "[]");
  if(!blockedUsers.includes(friend)){
    blockedUsers.push(friend);
    localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));

    let friends = JSON.parse(localStorage.getItem("friends") || "[]");
    friends = friends.filter(f => (typeof f === 'string' ? f !== friend : f.name !== friend));
    localStorage.setItem("friends", JSON.stringify(friends));

    alert(friend + " is blocked. You cannot send messages until unblocked.");
    updateInputState();
  }
});
updateInputState();

// --- Load Chat ---
const chatContainer = document.getElementById('chatMessages');
function loadChat(){
  chatContainer.innerHTML = '';
  getChat().forEach((msg, index)=>{
    const container = document.createElement('div');
    container.className = 'message-container ' + (msg.senderId===myId?'sent':'received');

    const div = document.createElement('div');
    div.className='message';
    div.dataset.index = index;

    if(msg.deleted){
      div.innerHTML = "<i>This message was deleted</i>";
    } else if(msg.type==='text'){
      if(msg.text === "My Location" && msg.data && msg.data.startsWith("https://maps.google.com/")){
        div.innerHTML += `<a href="${msg.data}" target="_blank">üìç My Location</a>`;
      } else div.innerHTML += msg.text;
    } else if(msg.type==='photo'){ div.innerHTML += `<img src="${msg.data}" class="preview">`; }
    else if(msg.type==='video'){ div.innerHTML += `<video src="${msg.data}" class="preview" controls></video>`; }
    else if(msg.type==='file'){ div.innerHTML += `üìÑ <a href="${msg.data}" download>Download File</a>`; }

    const ts = document.createElement('div');
    ts.className='timestamp';
    ts.innerText = msg.time;
    div.appendChild(ts);

    container.appendChild(div);
    chatContainer.appendChild(container);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}
loadChat();

// --- Delete Popup ---
const deletePopup = document.getElementById('deletePopup');
let currentMsgIndex = null;
let currentMsg = null;

function showDeleteMenu(msg, index, x, y){
  currentMsgIndex = index;
  currentMsg = msg;

  document.getElementById('deleteForEveryoneBtn').style.display = (msg.senderId === myId) ? 'block' : 'none';

  deletePopup.style.top = y + 'px';
  deletePopup.style.left = x + 'px';
  deletePopup.style.display = 'block';
}

document.addEventListener('click', e=>{
  if(!deletePopup.contains(e.target)) deletePopup.style.display = 'none';
});

document.getElementById('deleteForMeBtn').addEventListener('click', ()=>{
  deleteForMe(currentMsgIndex);
  deletePopup.style.display = 'none';
});

document.getElementById('deleteForEveryoneBtn').addEventListener('click', ()=>{
  deleteForEveryone(currentMsgIndex);
  deletePopup.style.display = 'none';
});

// --- Delete Functions ---
function deleteForMe(index){
  const messages = getChat();
  messages.splice(index, 1);
  saveChat(messages);
  loadChat();
}

function deleteForEveryone(index){
  const messages = getChat();
  messages[index].deleted = true;
  saveChat(messages);
  loadChat();
  socket.emit("delete message", {friend: friend, index: index});
}

socket.on("delete message", ({index})=>{
  const messages = getChat();
  if(messages[index]){
    messages[index].deleted = true;
    saveChat(messages);
    loadChat();
  }
});

// --- Message Sending ---
function sendMessage(){
  if(isBlocked(friend)) return alert("You cannot send messages to a blocked user!");
  const text = input.value.trim(); 
  if(!text) return;
  const msg = { senderId: myId, senderName: myName, profile: myPic, recipient: friend, type: "text", text: text, time: formatTime() };
  const messages = getChat();
  messages.push(msg);
  saveChat(messages);
  loadChat();
  socket.emit("private message", msg);
  input.value = "";
}
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

socket.on("private message", (msg)=>{
  if(msg.senderName === friend || msg.senderId === myId){
    const messages = getChat();
    messages.push(msg);
    saveChat(messages);
    loadChat();
  }
});

// --- Attachment Menu ---
const attachmentToggle = document.getElementById('attachmentToggle');
const attachmentMenu = document.getElementById('attachmentMenu');
attachmentToggle.addEventListener('click', () => {
  attachmentMenu.style.display = (attachmentMenu.style.display==='flex') ? 'none' : 'flex';
});
function closeAttachmentMenu() { attachmentMenu.style.display = 'none'; }

// --- Attachments ---
document.getElementById('sendFileBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const inputFile = document.createElement('input');
  inputFile.type='file';
  inputFile.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => sendAttachment('file', reader.result, file.name);
    reader.readAsDataURL(file);
  }
  inputFile.click();
});
document.getElementById('takePhotoBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const choice = confirm("Press OK to take a photo with camera, Cancel to pick from gallery");
  const inputPhoto = document.createElement('input');
  inputPhoto.type = 'file';
  inputPhoto.accept = 'image/*';
  if(choice) inputPhoto.capture = 'environment';
  inputPhoto.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>sendAttachment('photo', reader.result, file.name);
    reader.readAsDataURL(file);
  };
  inputPhoto.click();
});
document.getElementById('takeVideoBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const choice = confirm("Press OK to record video, Cancel to pick from gallery");
  const inputVideo = document.createElement('input');
  inputVideo.type = 'file';
  inputVideo.accept = 'video/*';
  if(choice) inputVideo.capture = 'camcorder';
  inputVideo.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>sendAttachment('video', reader.result, file.name);
    reader.readAsDataURL(file);
  };
  inputVideo.click();
});
document.getElementById('sendLocationBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  if(!navigator.geolocation) return alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const url = `https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
    sendAttachment('text', url, 'My Location');
  }, err=>alert("Location error: "+err.message));
});

function sendAttachment(type, data, name){
  const msg = { senderId: myId, senderName: myName, profile: myPic, recipient: friend, type:type, data:data, text:name||"", time:formatTime() };
  const messages = getChat(); messages.push(msg); saveChat(messages); loadChat();
  socket.emit("private message", msg);
}

// --- Long-press for mobile ---
let longPressTimer = null;
chatContainer.addEventListener('touchstart', e=>{
  const msgDiv = e.target.closest('.message');
  if(!msgDiv) return;
  const index = parseInt(msgDiv.dataset.index);
  const msg = getChat()[index];
  if(msg.deleted) return;
  longPressTimer = setTimeout(()=> showDeleteMenu(msg, index, e.touches[0].pageX, e.touches[0].pageY), 600);
});
chatContainer.addEventListener('touchend', e=> clearTimeout(longPressTimer));
chatContainer.addEventListener('touchmove', e=> clearTimeout(longPressTimer));

// --- Right-click for desktop ---
chatContainer.addEventListener('contextmenu', e=>{
  const msgDiv = e.target.closest('.message');
  if(!msgDiv) return;
  const index = parseInt(msgDiv.dataset.index);
  const msg = getChat()[index];
  if(msg.deleted) return;
  showDeleteMenu(msg, index, e.pageX, e.pageY);
  e.preventDefault();
});
</script>
</body>
</html>
