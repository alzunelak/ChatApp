<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chat with Friend</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#fff;color:#000;height:100vh;display:flex;flex-direction:column;}
  #chatPage,#friendInfoPage{display:flex;flex-direction:column;flex:1;}
  .header{display:flex;align-items:center;justify-content:space-between;background:#fff;padding:10px;border-bottom:1px solid #ccc;position:relative;}
  .header img{width:50px;height:50px;border-radius:50%;cursor:pointer;object-fit:cover;}
  .header-info{flex:1;display:flex;flex-direction:column;margin-left:10px;overflow:hidden;}
  .header-info h2{margin:0;font-size:16px;cursor:pointer;}
  .header-actions{display:flex;align-items:center;gap:15px;}
  .header-actions button{background:none;border:none;cursor:pointer;font-size:20px;color:#128C7E;}

  #chatBox{flex:1;overflow-y:auto;padding:10px;margin-bottom:100px;display:flex;flex-direction:column;gap:6px;}
  .msg{max-width:70%;padding:10px 14px;border-radius:18px;background:#f1f1f1;align-self:flex-start;word-break:break-word;}
  .msg.self{background:#dcf8c6;align-self:flex-end;}
  .msg .meta{display:block;margin-top:4px;font-size:10px;color:#999;text-align:right;}

  #inputArea{display:flex;align-items:center;position:fixed;bottom:10px;left:10px;width:calc(100% - 20px);z-index:100;}
  .input-box{display:flex;flex:1;background:#f1f1f1;border-radius:25px;padding:6px 10px;gap:6px;}
  .input-box input{flex:1;border:none;outline:none;font-size:14px;background:transparent;}
  .input-buttons button{background:transparent;border:none;font-size:20px;cursor:pointer;color:#128C7E;}
  #micBtn{width:40px;height:40px;border-radius:50%;background:#25D366;color:white;border:none;font-size:18px;display:flex;align-items:center;justify-content:center;margin-left:6px;}

  .popup{display:none;position:absolute;top:50px;right:10px;background:#fff;border:1px solid #ccc;border-radius:8px;z-index:1000;width:150px;}
  .popup div{padding:10px;cursor:pointer;border-bottom:1px solid #eee;}
  .popup div:hover{background:#f1f1f1;}

  #emojiPicker{position:absolute;bottom:60px;left:10px;background:#fff;border:1px solid #ccc;padding:10px;display:none;max-height:200px;overflow-y:auto;border-radius:8px;}
  #emojiPicker span{font-size:20px;padding:5px;cursor:pointer;}
  #emojiPicker span:hover{background:#eee;border-radius:5px;}

  /* Attachment Popup ‚Äî 3 columns x 2 rows */
  #attachPopup{
    display:none;position:absolute;bottom:60px;left:60px;background:#fff;border:1px solid #ccc;border-radius:12px;padding:12px;width:270px;
    box-shadow:0 6px 18px rgba(0,0,0,0.2);z-index:2000;display:none;
  }
  #attachGrid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
  }
  .attachItem{
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:10px;border-radius:10px;cursor:pointer;background:#f8f8f8;border:1px solid #eee;
    user-select:none;text-align:center;font-size:12px;
  }
  .attachItem:hover{background:#f1f1f1;}
  .attachItem i{font-size:20px;color:#075E54;}
  .attachItem input{display:none;}

  /* FRIEND INFO PAGE */
  #friendInfoPage{display:none;flex-direction:column;padding:20px;background:#f5f5f5;}
  .friendHeader{text-align:center;margin-bottom:20px;position:relative;}
  .friendHeader img{width:120px;height:120px;border-radius:50%;margin-bottom:10px;object-fit:cover;}
  .friendHeader h2{margin:0;font-size:22px;margin-bottom:20px;}
  .actionButtons{display:flex;justify-content:center;gap:30px;margin-bottom:20px;}
  .actionButtons button{display:flex;flex-direction:column;align-items:center;border:none;background:none;cursor:pointer;color:#075E54;}
  .actionButtons i{font-size:24px;}
  .settingsContainer,.groupsContainer,.actionBox{background:#fff;padding:10px;border-radius:10px;margin-bottom:20px;}
  .settingsContainer button,.groupsContainer button{width:100%;display:flex;align-items:center;gap:10px;padding:10px;border:none;border-radius:8px;margin-bottom:5px;cursor:pointer;}

  /* Block & Report = red text, no background */
  .actionBox button{width:100%;display:flex;align-items:center;gap:10px;padding:10px;border:none;border-radius:8px;cursor:pointer;margin-bottom:5px;background:none;font-weight:bold;}
  .actionBox .block{color:#f44336;}
  .actionBox .report{color:#ff5722;}

  .backArrow{cursor:pointer;font-size:22px;position:absolute;left:0;top:0;}
</style>
</head>
<body>

<!-- CHAT PAGE -->
<div id="chatPage">
  <div class="header">
    <img id="friendPhoto" src="default-profile.png" alt="friend">
    <div class="header-info">
      <h2 id="friendName"></h2>
    </div>
    <div class="header-actions">
      <button id="callBtn" title="Call"><i class="fa-solid fa-phone"></i></button>
      <button id="menuBtn" title="Menu"><i class="fa-solid fa-ellipsis-vertical"></i></button>
    </div>
    <div class="popup" id="menuPopup">
      <div onclick="openFriendInfo()">View Info</div>
      <div onclick="alert('Muted!')">Mute</div>
      <div onclick="deleteChat()">Delete Chat</div>
    </div>
  </div>

  <div id="chatBox"></div>

  <div id="inputArea">
    <div class="input-box">
      <input id="msgInput" placeholder="Type a message..." autocomplete="off">
      <div class="input-buttons">
        <button id="emojiBtn" title="Emoji"><i class="fa-solid fa-face-smile"></i></button>
        <button id="plusBtn" title="Attach"><i class="fa-solid fa-paperclip"></i></button>
      </div>
    </div>
    <button id="micBtn" title="Voice"><i class="fa-solid fa-microphone"></i></button>
  </div>
</div>

<!-- Emoji Picker -->
<div id="emojiPicker">
  <span>üòÄ</span><span>üòÇ</span><span>üòç</span><span>üò≠</span>
  <span>üòé</span><span>üò°</span><span>üëç</span><span>üôè</span>
  <span>üî•</span><span>üéâ</span><span>‚ù§Ô∏è</span>
</div>

<!-- ATTACHMENT POPUP (3 x 2 grid) -->
<div id="attachPopup">
  <div id="attachGrid">
    <!-- Gallery -->
    <label class="attachItem">
      <i class="fa-solid fa-image"></i>
      <span>Gallery</span>
      <input type="file" id="galleryInput" accept="image/*,video/*">
    </label>

    <!-- Camera -->
    <label class="attachItem">
      <i class="fa-solid fa-camera"></i>
      <span>Camera</span>
      <input type="file" id="cameraInput" accept="image/*,video/*" capture="environment">
    </label>

    <!-- Location -->
    <div class="attachItem" id="sendLocation">
      <i class="fa-solid fa-location-dot"></i>
      <span>Location</span>
    </div>

    <!-- Document -->
    <label class="attachItem">
      <i class="fa-solid fa-file"></i>
      <span>Document</span>
      <input type="file" id="documentInput" accept=".pdf,.doc,.docx,.txt">
    </label>

    <!-- Contact -->
    <div class="attachItem" id="sendContact">
      <i class="fa-solid fa-user"></i>
      <span>Contact</span>
    </div>

    <!-- Audio -->
    <label class="attachItem">
      <i class="fa-solid fa-microphone"></i>
      <span>Audio</span>
      <input type="file" id="audioInput" accept="audio/*">
    </label>
  </div>
</div>

<!-- FRIEND INFO PAGE -->
<div id="friendInfoPage">
  <div class="friendHeader">
    <i class="fa-solid fa-arrow-left backArrow" onclick="backToChat()"></i>
    <img id="infoFriendPhoto" src="default-profile.png" alt="friend">
    <h2 id="infoFriendName">Friend Name</h2>
    <div class="actionButtons">
      <button><i class="fa-solid fa-video"></i><span>Video Call</span></button>
      <button><i class="fa-solid fa-phone"></i><span>Audio Call</span></button>
      <button><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></button>
    </div>
  </div>

  <div class="settingsContainer">
    <button><i class="fa-solid fa-lock"></i> End-to-End Encryption</button>
    <button><i class="fa-solid fa-network-wired"></i> Mesh Network Form</button>
    <button><i class="fa-solid fa-paint-roller"></i> Chat Color & Wallpaper</button>
    <button><i class="fa-solid fa-shield"></i> Advanced Chat Privacy</button>
  </div>

  <div class="groupsContainer">
    <div>No groups in common</div>
    <button>+</button>
  </div>

  <div class="actionBox">
    <button class="block" onclick="confirmBlock()"><i class="fa-solid fa-ban"></i> Block User</button>
    <button class="report" onclick="confirmReport()"><i class="fa-solid fa-flag"></i> Report User</button>
  </div>
</div>

<script>
/* --------- User & Friend --------- */
const myName = localStorage.getItem("username") || "Me";
const myPic  = localStorage.getItem("profilePic") || "default-profile.png";
const myId   = localStorage.getItem("userId") || ("guest_" + Math.floor(Math.random()*100000));

const params = new URLSearchParams(window.location.search);
const friendParam = params.get("friend") ? decodeURIComponent(params.get("friend")) : "Friend";
const friendsList = JSON.parse(localStorage.getItem("friends") || "[]");
const friendObj = friendsList.find(f => f.name === friendParam);
const friendData = {
  name: friendObj ? friendObj.name : friendParam,
  photo: friendObj && friendObj.profile ? friendObj.profile : "default-profile.png"
};

/* --------- DOM --------- */
const friendNameEl  = document.getElementById("friendName");
const friendPhotoEl = document.getElementById("friendPhoto");
const infoFriendNameEl  = document.getElementById("infoFriendName");
const infoFriendPhotoEl = document.getElementById("infoFriendPhoto");
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");

/* --------- Init headers --------- */
friendNameEl.textContent = friendData.name;
friendPhotoEl.src = friendData.photo;
infoFriendNameEl.textContent = friendData.name;
infoFriendPhotoEl.src = friendData.photo;
friendPhotoEl.onerror = () => { friendPhotoEl.src = "default-profile.png"; };
infoFriendPhotoEl.onerror = () => { infoFriendPhotoEl.src = "default-profile.png"; };

/* --------- Chat State --------- */
let messages = JSON.parse(localStorage.getItem(`chat_${friendData.name}`) || "[]");

function uid(){ return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8); }

function saveMessages(){
  localStorage.setItem(`chat_${friendData.name}`, JSON.stringify(messages));
}

function timeNow(){
  return new Date().toLocaleTimeString();
}

function appendMessageBubble(obj){
  const div = document.createElement("div");
  div.className = "msg" + (obj.senderId === myId ? " self" : "");
  div.innerHTML = `<div>${obj.text}</div><span class="meta">${obj.time}</span>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function renderMessages(){
  chatBox.innerHTML = "";
  messages.forEach(appendMessageBubble);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* --------- Text sending --------- */
msgInput.addEventListener("keydown", e=>{
  if(e.key === "Enter"){
    e.preventDefault();
    const txt = msgInput.value.trim();
    if(!txt) return;
    const msg = { id: uid(), senderId: myId, senderName: myName, text: txt, time: timeNow() };
    messages.push(msg);
    saveMessages();
    appendMessageBubble(msg);
    msgInput.value = "";
  }
});

/* --------- Emoji picker --------- */
document.getElementById("emojiBtn").addEventListener("click", ()=>{
  const ep = document.getElementById("emojiPicker");
  ep.style.display = ep.style.display === "block" ? "none" : "block";
});
document.getElementById("emojiPicker").addEventListener("click", e=>{
  if(e.target.tagName === "SPAN"){
    msgInput.value += e.target.textContent;
    msgInput.focus();
    document.getElementById("emojiPicker").style.display = "none";
  }
});

/* --------- Menu popup --------- */
const menuBtn = document.getElementById("menuBtn");
const menuPopup = document.getElementById("menuPopup");
menuBtn.onclick = ()=>{ menuPopup.style.display = menuPopup.style.display==="block" ? "none" : "block"; };
document.addEventListener("click", e=>{
  if(!menuBtn.contains(e.target) && !menuPopup.contains(e.target)) menuPopup.style.display="none";
});

/* --------- Friend Info navigation --------- */
friendNameEl.onclick = openFriendInfo;
friendPhotoEl.onclick = openFriendInfo;
function openFriendInfo(){
  document.getElementById("chatPage").style.display="none";
  document.getElementById("friendInfoPage").style.display="flex";
}
function backToChat(){
  document.getElementById("friendInfoPage").style.display="none";
  document.getElementById("chatPage").style.display="flex";
}

/* --------- Delete chat --------- */
function deleteChat(){
  if(confirm("Delete all messages?")){
    messages = [];
    localStorage.removeItem(`chat_${friendData.name}`);
    renderMessages();
  }
}

/* --------- Attachments (3x2) --------- */
const attachBtn = document.getElementById("plusBtn");
const attachPopup = document.getElementById("attachPopup");

attachBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  attachPopup.style.display = (attachPopup.style.display === "block") ? "none" : "block";
});

// Close attach popup when clicking outside
document.addEventListener("click", e=>{
  if(!attachBtn.contains(e.target) && !attachPopup.contains(e.target)){
    attachPopup.style.display = "none";
  }
});

// Helper to append an attachment message
function sendAttachmentMessage(text){
  const msg = { id: uid(), senderId: myId, senderName: myName, text, time: timeNow() };
  messages.push(msg);
  saveMessages();
  appendMessageBubble(msg);
  attachPopup.style.display = "none";
}

/* ---- File handlers ---- */
document.getElementById("galleryInput").addEventListener("change", e=>{
  const file = e.target.files && e.target.files[0];
  if(file){
    const label = file.type.startsWith("video") ? "üé¨" : "üì∑";
    sendAttachmentMessage(`${label} Sent from gallery: ${file.name}`);
    e.target.value = ""; // reset so same file can be chosen again
  }
});

document.getElementById("cameraInput").addEventListener("change", e=>{
  const file = e.target.files && e.target.files[0];
  if(file){
    const label = file.type.startsWith("video") ? "üé•" : "üì∏";
    sendAttachmentMessage(`${label} Captured: ${file.name}`);
    e.target.value = "";
  }
});

document.getElementById("documentInput").addEventListener("change", e=>{
  const file = e.target.files && e.target.files[0];
  if(file){
    sendAttachmentMessage(`üìÑ Document: ${file.name}`);
    e.target.value = "";
  }
});

document.getElementById("audioInput").addEventListener("change", e=>{
  const file = e.target.files && e.target.files[0];
  if(file){
    sendAttachmentMessage(`üéµ Audio: ${file.name}`);
    e.target.value = "";
  }
});

// Location (GPS)
document.getElementById("sendLocation").addEventListener("click", ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude.toFixed(5);
      const lng = pos.coords.longitude.toFixed(5);
      // Add a simple maps link text
      sendAttachmentMessage(`üìç Location: ${lat}, ${lng} (https://maps.google.com/?q=${lat},${lng})`);
    }, err=>{
      sendAttachmentMessage("üìç Location sharing denied.");
    });
  }else{
    sendAttachmentMessage("üìç Geolocation not supported.");
  }
});

// Contact (prompt for demo)
document.getElementById("sendContact").addEventListener("click", ()=>{
  const name = prompt("Contact name:");
  if(name !== null){
    const phone = prompt("Phone number:");
    if(phone !== null){
      sendAttachmentMessage(`üë§ Contact: ${name} ‚Äî ${phone}`);
    }
  }
});

/* --------- Block / Report --------- */
function confirmBlock(){
  if(confirm("Are you sure you want to block this user?")){
    let blocked = JSON.parse(localStorage.getItem("blockedUsers") || "[]");
    if(!blocked.includes(friendData.name)) blocked.push(friendData.name);
    localStorage.setItem("blockedUsers", JSON.stringify(blocked));
    window.location.href = "home.html";
  }
}
function confirmReport(){
  if(confirm("Are you sure you want to report this user?")){
    let reported = JSON.parse(localStorage.getItem("reportedUsers") || "[]");
    if(!reported.includes(friendData.name)) reported.push(friendData.name);
    localStorage.setItem("reportedUsers", JSON.stringify(reported));
    window.location.href = "home.html";
  }
}

/* --------- First render --------- */
renderMessages();
</script>
</body>
</html>
