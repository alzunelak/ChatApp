<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Chat</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#fff;color:#000;height:100vh;display:flex;flex-direction:column;}
/* CHAT PAGE */
#chatPage{flex:1;display:flex;flex-direction:column;}
.header{display:flex;align-items:center;justify-content:space-between;background:#075E54;color:white;padding:10px;}
.header img{width:50px;height:50px;border-radius:50%;cursor:pointer;object-fit:cover;}
.header-info{flex:1;display:flex;flex-direction:column;margin-left:10px;overflow:hidden;}
.header-info h2{margin:0;font-size:16px;cursor:pointer;}
#chatBox{flex:1;overflow-y:auto;padding:10px;margin-bottom:100px;}
.msg{max-width:70%;padding:10px 14px;margin:5px 0;border-radius:18px;background:#f1f1f1;align-self:flex-start;position:relative;word-break:break-word;cursor:pointer;}
.msg.self{background:#dcf8c6;align-self:flex-end;}
.msg .meta{font-size:10px;color:#999;text-align:right;}
#inputArea{display:flex;align-items:center;position:fixed;bottom:10px;left:10px;width:calc(100%-20px);z-index:100;}
.input-box{display:flex;flex:1;background:#f1f1f1;border-radius:25px;padding:6px 10px;gap:6px;}
.input-box input{flex:1;border:none;outline:none;font-size:14px;background:transparent;}
.input-buttons button{background:transparent;border:none;font-size:20px;cursor:pointer;color:#128C7E;}
#micBtn{width:40px;height:40px;border-radius:50%;background:#25D366;color:white;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:6px;}
.preview{max-width:200px;border-radius:10px;margin-top:5px;}
/* PROFILE PAGE */
#profilePage{display:none;flex-direction:column;flex:1;background:#fff;}
.profileHeader{display:flex;align-items:center;background:#075E54;color:white;padding:10px;position:relative;}
.backBtn{position:absolute;left:10px;font-size:20px;cursor:pointer;}
.profileHeader img{width:80px;height:80px;border-radius:50%;object-fit:cover;margin:auto;}
.profileHeader h2{text-align:center;margin:10px 0;}
.profileActions{display:flex;justify-content:center;gap:20px;margin-top:10px;}
.profileActions button{padding:10px 15px;border:none;background:#25D366;color:white;border-radius:8px;cursor:pointer;}
/* DELETE POPUP */
#deletePopup{position:absolute;display:none;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:1000;padding:5px;}
#deletePopup button{background:none;border:none;padding:5px 10px;cursor:pointer;width:100%;text-align:left;}
#deletePopup button:hover{background:#f0f0f0;}
</style>
</head>
<body>

<!-- CHAT PAGE -->
<div id="chatPage">
  <div class="header">
    <img id="userPhoto" src="profile.png">
    <div class="header-info">
      <h2 id="userName">Friend</h2>
    </div>
    <div class="header-actions">
      <button id="callBtn"><i class="fa-solid fa-phone"></i></button>
    </div>
  </div>
  <div id="chatBox"></div>
  <div id="inputArea">
    <div class="input-box">
      <input id="msgInput" placeholder="Type a message...">
      <div class="input-buttons">
        <button id="emojiBtn"><i class="fa-solid fa-face-smile"></i></button>
        <button id="plusBtn"><i class="fa-solid fa-paperclip"></i></button>
      </div>
    </div>
    <button id="micBtn"><i class="fa-solid fa-microphone"></i></button>
  </div>
</div>

<!-- PROFILE PAGE -->
<div id="profilePage">
  <div class="profileHeader">
    <i class="fa-solid fa-arrow-left backBtn" onclick="backToChat()"></i>
    <img id="profilePhoto" src="profile.png">
    <h2 id="profileName">Friend</h2>
  </div>
  <div class="profileActions">
    <button id="blockBtn">Block</button>
    <button id="callProfileBtn">Call</button>
  </div>
</div>

<!-- DELETE POPUP -->
<div id="deletePopup">
  <button id="deleteForMeBtn">üóë Delete for me</button>
  <button id="deleteForEveryoneBtn">‚ùå Delete for everyone</button>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// ===== STATE =====
let myName = localStorage.getItem("username") || "You";
let friendName = "Friend";
let friendPhoto = "profile.png";
let myId = localStorage.getItem("userId") || ("guest_" + Math.floor(Math.random()*100000));
let messages = JSON.parse(localStorage.getItem("chat_"+friendName)||"[]");

// ===== SOCKET.IO =====
const socket = io("http://localhost:3000");
socket.emit("register", myName);
socket.on("private message", msg=>{
  if(msg.user===friendName || msg.self) {
    messages.push(msg);
    saveMessages();
    renderMessages();
  }
});

// ===== ELEMENTS =====
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");
const deletePopup = document.getElementById("deletePopup");
let currentMsgIndex = null;

// ===== SEND MESSAGE =====
msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") { e.preventDefault(); sendMessage(); }
});

function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  const msg={text,user:myName,self:true,time:new Date().toLocaleTimeString(),type:"text"};
  messages.push(msg);
  saveMessages();
  renderMessages();
  msgInput.value="";
  socket.emit("private message", msg);
}

// ===== RENDER =====
function renderMessages(){
  chatBox.innerHTML="";
  messages.forEach((m,i)=>{
    const div=document.createElement("div");
    div.className="msg"+(m.self?" self":"");
    div.dataset.index = i;
    if(m.type==="text") div.innerHTML=`<b>${m.user}:</b> ${m.text}<div class="meta">${m.time}</div>`;
    else if(m.type==="image") div.innerHTML=`<b>${m.user}:</b><br><img src="${m.text}" class="preview"><div class="meta">${m.time}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ===== LOCAL STORAGE =====
function saveMessages(){ localStorage.setItem("chat_"+friendName, JSON.stringify(messages)); }

// ===== DELETE MESSAGE =====
chatBox.addEventListener("contextmenu", e=>{
  e.preventDefault();
  const msgDiv = e.target.closest(".msg");
  if(!msgDiv) return;
  currentMsgIndex = parseInt(msgDiv.dataset.index);
  const msg = messages[currentMsgIndex];
  deletePopup.style.top = (e.clientY-40)+"px";
  deletePopup.style.left = (e.clientX-60)+"px";
  deletePopup.style.display="block";
});

document.addEventListener("click", e=>{
  if(!deletePopup.contains(e.target)) deletePopup.style.display="none";
});

document.getElementById("deleteForMeBtn").addEventListener("click", ()=>{
  messages.splice(currentMsgIndex,1);
  saveMessages();
  renderMessages();
  deletePopup.style.display="none";
});

document.getElementById("deleteForEveryoneBtn").addEventListener("click", ()=>{
  messages[currentMsgIndex].deleted = true;
  saveMessages();
  renderMessages();
  socket.emit("delete message",{index:currentMsgIndex,friend:friendName});
  deletePopup.style.display="none";
});

socket.on("delete message", ({index})=>{
  if(messages[index]) messages[index].deleted = true;
  saveMessages(); renderMessages();
});

// ===== PROFILE PAGE =====
const chatPage = document.getElementById("chatPage");
const profilePage = document.getElementById("profilePage");
document.getElementById("userName").addEventListener("click", openProfile);

function openProfile(){
  chatPage.style.display="none";
  profilePage.style.display="flex";
  document.getElementById("profileName").textContent = friendName;
  document.getElementById("profilePhoto").src = friendPhoto;
}

function backToChat(){
  profilePage.style.display="none";
  chatPage.style.display="flex";
}

// ===== BLOCK FRIEND =====
document.getElementById("blockBtn").addEventListener("click", ()=>{
  if(confirm("Block "+friendName+"?")){
    alert(friendName+" blocked!");
  }
});
</script>
</body>
</html>
