<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>One-to-One Chat</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {margin:0;font-family:Arial,sans-serif;background:#e5ddd5;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
/* --- CHAT HEADER --- */
.chat-header {background:#075E54;color:white;padding:10px 15px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;cursor:pointer;}
.chat-header-left {display:flex;align-items:center;}
.chat-header-left img {width:40px;height:40px;border-radius:50%;margin-right:10px;object-fit:cover;}
.chat-header-right button {background:none;border:none;color:white;font-size:20px;margin-left:10px;cursor:pointer;}
/* --- MESSAGES --- */
.chat-messages {flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;}
.message-container {display:flex;margin:5px 0;align-items:flex-end;position:relative;}
.message-container.sent {justify-content:flex-end;}
.message-container.received {justify-content:flex-start;}
.message-container.received img {width:30px;height:30px;border-radius:50%;margin-right:5px;object-fit:cover;}
.message {max-width:70%;padding:8px 12px;border-radius:18px;position:relative;word-wrap:break-word;cursor:pointer;}
.sent .message {background:#dcf8c6;align-self:flex-end;}
.received .message {background:white;align-self:flex-start;}
.timestamp {font-size:10px;color:#888;margin-top:2px;text-align:right;}
/* --- INPUT --- */
.chat-input {display:flex;padding:10px;background:#f0f0f0;align-items:center;position:sticky;bottom:0;z-index:10;}
.chat-input input {flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;margin-right:5px;}
.chat-input button {padding:0 12px;border:none;background:#25D366;color:white;border-radius:50%;font-size:22px;cursor:pointer;margin-left:5px;}
.preview{max-width:200px;border-radius:10px;margin-top:5px;}
/* --- ATTACHMENT --- */
.circle-btn {width:40px;height:40px;border-radius:50%;border:none;background:#25D366;color:white;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:5px;}
.attachment-menu {position:absolute;bottom:60px;left:10px;display:none;flex-direction:column;gap:10px;}
.attachment-btn {width:50px;height:50px;border-radius:50%;border:none;background:#075E54;color:white;font-size:22px;cursor:pointer;}
/* --- DELETE --- */
#deletePopup {position:absolute;display:none;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);z-index:100;padding:5px;}
#deletePopup button {background:none;border:none;padding:5px 10px;cursor:pointer;width:100%;text-align:left;}
#deletePopup button:hover {background:#f0f0f0;}
/* --- PROFILE PAGE --- */
#profilePage {display:none;flex-direction:column;height:100%;}
.profile-header {display:flex;align-items:center;background:#075E54;color:white;padding:15px;position:sticky;top:0;}
.profile-header img {width:60px;height:60px;border-radius:50%;margin-right:10px;}
.profile-header h2 {margin:0;font-size:18px;}
.profile-back {margin-right:10px;cursor:pointer;font-size:20px;}
</style>
</head>
<body>

<!-- CHAT PAGE -->
<div id="chatPage">
  <div class="chat-header">
    <div class="chat-header-left">
      <img id="friendProfile" src="default-profile.png">
      <span id="friendName">Friend</span>
    </div>
    <div class="chat-header-right">
      <button id="blockBtn">üö´</button>
    </div>
  </div>

  <div class="chat-messages" id="chatMessages"></div>

  <div class="chat-input">
    <button id="attachmentToggle" class="circle-btn">+</button>
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendBtn">‚û°</button>
  </div>

  <div id="attachmentMenu" class="attachment-menu">
    <button class="attachment-btn" id="sendFileBtn">üìÑ</button>
    <button class="attachment-btn" id="takePhotoBtn">üì∏</button>
    <button class="attachment-btn" id="takeVideoBtn">üé•</button>
    <button class="attachment-btn" id="sendLocationBtn">üìç</button>
  </div>

  <div id="deletePopup">
    <button id="deleteForMeBtn">üóë Delete for me</button>
    <button id="deleteForEveryoneBtn">‚ùå Delete for everyone</button>
  </div>
</div>

<!-- PROFILE PAGE -->
<div id="profilePage">
  <div class="profile-header">
    <span class="profile-back" onclick="backToChat()">‚¨Ö</span>
    <img id="profilePhoto" src="default-profile.png">
    <h2 id="profileName">Friend</h2>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// --- USER ---
const myName = localStorage.getItem("username") || "Me";
const myPic = localStorage.getItem("profilePic") || "default-profile.png";
const myId  = localStorage.getItem("userId") || ("guest_" + Math.floor(Math.random()*100000));

// --- FRIEND ---
const params = new URLSearchParams(window.location.search);
const friend = params.get('friend') || 'John Doe';
const friendsList = JSON.parse(localStorage.getItem('friends') || '[]');
const friendObj = friendsList.find(f => f.name === friend);
const friendName = friendObj ? friendObj.name : friend;
const friendPhoto = friendObj && friendObj.profile ? friendObj.profile : 'default-profile.png';

// SET HEADER
const friendNameEl = document.getElementById('friendName');
const friendProfileEl = document.getElementById('friendProfile');
friendNameEl.innerText = friendName;
friendProfileEl.src = friendPhoto;
friendProfileEl.onerror = () => { friendProfileEl.src='default-profile.png'; }

// SOCKET.IO
const socket = io("http://localhost:3000");
socket.emit("register", myName);

// CHAT STORAGE
function getChat(){ return JSON.parse(localStorage.getItem(`chat_${friend}`)||'[]'); }
function saveChat(messages){ localStorage.setItem(`chat_${friend}`, JSON.stringify(messages)); }
function formatTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

// BLOCK
function isBlocked(friendName){
  const blockedUsers = JSON.parse(localStorage.getItem("blockedUsers")||"[]");
  return blockedUsers.includes(friendName);
}
const blockBtn = document.getElementById('blockBtn');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
function updateInputState(){
  if(isBlocked(friend)){
    input.disabled=true; input.placeholder="You have blocked this user."; sendBtn.disabled=true;
  } else { input.disabled=false; input.placeholder="Type a message..."; sendBtn.disabled=false; }
}
blockBtn.addEventListener('click', ()=>{
  let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers") || "[]");
  if(!blockedUsers.includes(friend)){
    blockedUsers.push(friend);
    localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));
    alert(friend + " is blocked.");
    updateInputState();
  }
});
updateInputState();

// LOAD CHAT
const chatContainer = document.getElementById('chatMessages');
function loadChat(){
  chatContainer.innerHTML='';
  getChat().forEach((msg,index)=>{
    const container=document.createElement('div');
    container.className='message-container '+(msg.senderId===myId?'sent':'received');
    const div=document.createElement('div'); div.className='message'; div.dataset.index=index;
    if(msg.deleted){ div.innerHTML="<i>This message was deleted</i>"; }
    else if(msg.type==='text'){ div.innerHTML=msg.text; }
    else if(msg.type==='photo'){ div.innerHTML=`<img src="${msg.data}" class="preview">`; }
    else if(msg.type==='video'){ div.innerHTML=`<video src="${msg.data}" class="preview" controls></video>`; }
    else if(msg.type==='file'){ div.innerHTML=`üìÑ <a href="${msg.data}" download>Download File</a>`; }
    const ts=document.createElement('div'); ts.className='timestamp'; ts.innerText=msg.time; div.appendChild(ts);
    container.appendChild(div); chatContainer.appendChild(container);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}
loadChat();

// SEND MESSAGE
function sendMessage(){
  if(isBlocked(friend)) return alert("Cannot send to blocked user!");
  const text=input.value.trim(); if(!text) return;
  const msg={ senderId:myId, senderName:myName, type:"text", text:text, time:formatTime() };
  const messages=getChat(); messages.push(msg); saveChat(messages); loadChat();
  socket.emit("private message", msg); input.value="";
}
sendBtn.addEventListener('click', sendMessage);
input.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

// RECEIVE MESSAGE
socket.on("private message", msg=>{
  const messages=getChat(); messages.push(msg); saveChat(messages); loadChat();
});

// DELETE MESSAGE
const deletePopup = document.getElementById('deletePopup');
let currentMsgIndex=null; let currentMsg=null;
function showDeleteMenu(msg,index,msgDiv){
  currentMsgIndex=index; currentMsg=msg;
  document.getElementById('deleteForEveryoneBtn').style.display=(msg.senderId===myId?'block':'none');
  const rect=msgDiv.getBoundingClientRect(),chatRect=chatContainer.getBoundingClientRect();
  const popupWidth=deletePopup.offsetWidth||150;
  let left=rect.left+rect.width/2-popupWidth/2;
  left=Math.max(chatRect.left+5,Math.min(left,chatRect.right-popupWidth-5));
  const top=rect.top-deletePopup.offsetHeight-5;
  deletePopup.style.left=left+'px'; deletePopup.style.top=top+'px'; deletePopup.style.display='block';
}
document.addEventListener('click', e=>{ if(!deletePopup.contains(e.target)) deletePopup.style.display='none'; });
document.getElementById('deleteForMeBtn').addEventListener('click', ()=>{
  const messages=getChat(); messages.splice(currentMsgIndex,1); saveChat(messages); loadChat(); deletePopup.style.display='none';
});
document.getElementById('deleteForEveryoneBtn').addEventListener('click', ()=>{
  const messages=getChat(); messages[currentMsgIndex].deleted=true; saveChat(messages); loadChat(); deletePopup.style.display='none';
  socket.emit("delete message",{friend:friend,index:currentMsgIndex});
});
socket.on("delete message",({index})=>{
  const messages=getChat(); if(messages[index]){ messages[index].deleted=true; saveChat(messages); loadChat(); }
});

// CLICK HEADER TO OPEN PROFILE
const chatPage = document.getElementById("chatPage");
const profilePage = document.getElementById("profilePage");
const profilePhoto = document.getElementById("profilePhoto");
const profileName = document.getElementById("profileName");

// click header-left only
document.querySelector(".chat-header-left").addEventListener("click", ()=>{
  chatPage.style.display="none";
  profilePage.style.display="flex";
  profilePhoto.src=friendPhoto;
  profileName.textContent=friendName;
});
function backToChat(){ profilePage.style.display="none"; chatPage.style.display="flex"; }
</script>
</body>
</html>
