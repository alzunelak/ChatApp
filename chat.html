<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body{font-family:Arial;margin:0;padding:0;background:#e5ddd5;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
/* Header */
.chat-header{background:#075E54;color:white;padding:10px 15px;font-size:18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.chat-header-left{display:flex;align-items:center;}
.chat-header-left img{width:40px;height:40px;border-radius:50%;margin-right:10px;}
.chat-header-right button{background:none;border:none;color:white;font-size:20px;margin-left:10px;cursor:pointer;}
/* Chat messages */
.chat-messages{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;}
.message{max-width:70%;padding:8px 12px;border-radius:18px;margin:5px 0;position:relative;word-wrap:break-word;}
.sent{background:#dcf8c6;align-self:flex-end;}
.received{background:white;align-self:flex-start;}
.timestamp{font-size:10px;color:#888;margin-top:2px;text-align:right;}
/* Bottom input */
.chat-input{display:flex;padding:10px;background:#f0f0f0;align-items:center;position:sticky;bottom:0;z-index:10;}
.chat-input input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;margin-right:5px;}
.chat-input button{padding:0 12px;border:none;background:#25D366;color:white;border-radius:50%;font-size:22px;cursor:pointer;margin-left:5px;}
/* Attachment popup */
.attach-popup{position:absolute;background:white;padding:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:none;flex-direction:column;z-index:20;}
.attach-popup button{margin:5px 0;padding:8px;border:none;background:#075E54;color:white;border-radius:8px;cursor:pointer;}
/* Message options */
.msg-options{position:absolute;background:white;padding:5px 10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:none;z-index:100;}
.msg-options button{border:none;background:none;color:#075E54;padding:5px 10px;cursor:pointer;}
/* Media previews */
.preview{max-width:200px;border-radius:10px;margin-top:5px;}
</style>
</head>
<body>

<!-- Header -->
<div class="chat-header">
  <div class="chat-header-left">
    <img id="friendProfile" src="">
    <span id="friendName">Friend</span>
  </div>
  <div class="chat-header-right">
    <button id="audioCallBtn">üé§</button>
    <button id="videoCallBtn">üìπ</button>
    <button id="blockBtn">üö´</button>
  </div>
</div>

<!-- Chat messages -->
<div class="chat-messages" id="chatMessages"></div>

<!-- Attachment popup -->
<div class="attach-popup" id="attachPopup">
  <button id="attachLocation">üìç Location</button>
  <button id="attachFile">üìÑ File</button>
  <button id="attachPhoto">üì∑ Photo</button>
  <button id="attachVideo">üé• Video</button>
</div>

<!-- Bottom input -->
<div class="chat-input">
  <button id="plusBtn">‚ûï</button>
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button id="sendBtn">‚û°</button>
</div>

<script>
// --- Setup ---
const params = new URLSearchParams(window.location.search);
const friend = params.get('friend') || 'John Doe';
const profile = params.get('profile') || '';
document.getElementById('friendName').innerText = friend;
document.getElementById('friendProfile').src = profile;

// Blocked users
let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers')||'[]');

const chatContainer = document.querySelector('.chat-messages');
const chatInput = document.querySelector('.chat-input');
const chatHeader = document.querySelector('.chat-header');

function isBlocked(){ return blockedUsers.includes(friend); }
function hideChat(){
  chatContainer.innerHTML='';
  chatInput.style.display='none';
  chatHeader.innerHTML = `<div style="padding:20px;text-align:center;width:100%;color:#075E54;font-weight:bold;">
    You have blocked ${friend}. Go to Blocked Users to unblock.
  </div>`;
}

// Check blocked on load
if(isBlocked()) hideChat();

// Chat storage
function getChat(){ return JSON.parse(localStorage.getItem(`chat_${friend}`)||'[]'); }
function saveChat(messages){ localStorage.setItem(`chat_${friend}`, JSON.stringify(messages)); }
function formatTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

// Load chat
function loadChat(){
  chatContainer.innerHTML='';
  if(isBlocked()){ hideChat(); return; }
  getChat().forEach((msg,i)=>{
    const div = document.createElement('div');
    div.classList.add('message', msg.sender==='me'?'sent':'received');
    if(msg.type==='text') div.innerText = msg.text;
    else if(msg.type==='location') div.innerHTML=`üìç <a href="${msg.data}" target="_blank">View Location</a>`;
    else if(msg.type==='photo') div.innerHTML=`<img src="${msg.data}" class="preview">`;
    else if(msg.type==='video') div.innerHTML=`<video src="${msg.data}" class="preview" controls></video>`;
    else if(msg.type==='file') div.innerHTML=`üìÑ <a href="${msg.data}" download>Download File</a>`;

    const ts = document.createElement('div'); ts.className='timestamp'; ts.innerText = msg.time;
    div.appendChild(ts);

    // Right click or long press for mobile
    attachMessageOptions(div,i);

    chatContainer.appendChild(div);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Send message
document.getElementById('sendBtn').addEventListener('click', ()=>{
  if(isBlocked()){ alert('Cannot send message. User is blocked.'); return; }
  const input = document.getElementById('messageInput');
  if(!input.value) return;
  const messages = getChat();
  messages.push({type:'text',text:input.value,sender:'me',time:formatTime()});
  saveChat(messages);
  input.value='';
  loadChat();
});

// Attachment popup toggle
const plusBtn = document.getElementById('plusBtn');
const attachPopup = document.getElementById('attachPopup');
plusBtn.addEventListener('click', ()=>{
  attachPopup.style.display = attachPopup.style.display==='flex'?'none':'flex';
  attachPopup.style.flexDirection='column';
  const inputRect = document.querySelector('.chat-input').getBoundingClientRect();
  attachPopup.style.bottom = `${window.innerHeight - inputRect.top + 10}px`;
});

// Attachment buttons
document.getElementById('attachLocation').addEventListener('click', ()=>{
  if(isBlocked()){ alert('Cannot send message. User is blocked.'); return; }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const url = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
      const messages = getChat();
      messages.push({type:'location',data:url,sender:'me',time:formatTime()});
      saveChat(messages); loadChat();
    });
  }
});
function attachFileHandler(type,accept){
  const file = document.createElement('input'); file.type='file'; file.accept=accept||'*';
  file.onchange = e=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const messages = getChat();
      messages.push({type:type,data:reader.result,sender:'me',time:formatTime()});
      saveChat(messages); loadChat();
    }
    reader.readAsDataURL(file.files[0]);
  }
  file.click();
}
document.getElementById('attachPhoto').addEventListener('click', ()=> attachFileHandler('photo','image/*'));
document.getElementById('attachVideo').addEventListener('click', ()=> attachFileHandler('video','video/*'));
document.getElementById('attachFile').addEventListener('click', ()=> attachFileHandler('file'));

// Message options (Delete/Edit)
function attachMessageOptions(msgDiv,index){
  // Desktop right-click
  msgDiv.addEventListener('contextmenu', e=>{
    e.preventDefault();
    showMsgOptions(msgDiv,index);
  });

  // Mobile long-press
  let pressTimer;
  msgDiv.addEventListener('touchstart', e=>{
    pressTimer = setTimeout(()=> showMsgOptions(msgDiv,index), 600);
  });
  msgDiv.addEventListener('touchend', e=> clearTimeout(pressTimer));
  msgDiv.addEventListener('touchmove', e=> clearTimeout(pressTimer));
}

function showMsgOptions(msgDiv,index){
  document.querySelectorAll('.msg-options').forEach(o=>o.remove());
  let options = document.createElement('div');
  options.className='msg-options';
  options.style.top = msgDiv.offsetTop - 5 + 'px';
  options.style.left = msgDiv.offsetLeft + 'px';

  const delAll = document.createElement('button'); delAll.innerText='Delete for everyone';
  delAll.onclick = ()=>{
    let messages = getChat(); messages.splice(index,1); saveChat(messages); loadChat(); options.remove();
  };

  const delMe = document.createElement('button'); delMe.innerText='Delete for me';
  delMe.onclick = ()=>{
    let messages = getChat();
    if(messages[index].sender==='me'){ messages.splice(index,1); saveChat(messages); loadChat(); }
    else alert('Cannot delete others message for you.');
    options.remove();
  };

  const editBtn = document.createElement('button'); editBtn.innerText='Edit';
  editBtn.onclick = ()=>{
    let messages = getChat();
    if(messages[index].sender==='me'){
      let newText = prompt('Edit your message:', messages[index].text);
      if(newText!==null && newText.trim()!==''){
        messages[index].text = newText;
        saveChat(messages);
        loadChat();
      }
    } else alert('Cannot edit others message.');
    options.remove();
  };

  options.appendChild(delAll);
  options.appendChild(delMe);
  options.appendChild(editBtn);
  document.body.appendChild(options);

  document.addEventListener('click', function hide(e){
    if(!options.contains(e.target)){ options.remove(); document.removeEventListener('click',hide); }
  });
}

// Block button
document.getElementById('blockBtn').addEventListener('click', ()=>{
  if(!blockedUsers.includes(friend)){
    blockedUsers.push(friend);
    localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
    localStorage.removeItem(`chat_${friend}`);
    hideChat();
    alert(`${friend} is blocked!`);
  }
});

// Initial load
loadChat();
</script>
</body>
</html>
