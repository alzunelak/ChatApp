<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scan Friend QR Code</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f5f5f5; }
#reader { width:300px; margin:auto; }
#message { margin-top:20px; font-size:16px; }
button { padding:10px 20px; font-size:16px; margin-top:10px; cursor:pointer; }
</style>
</head>
<body>
<h2>Scan Friend QR Code</h2>
<div id="reader"></div>
<div id="message"></div>
<button id="stopBtn">Stop Scan</button>

<script>
const messageDiv = document.getElementById('message');
const channel = new BroadcastChannel('chatapp');
const defaultProfile = "default-profile.png";

// Add friend locally
function addFriendObject(name, profile){
  let friends = JSON.parse(localStorage.getItem('friends')||'[]');
  if(!friends.some(f => f.name===name)){
    const newFriend = {name, profile};
    friends.push(newFriend);
    localStorage.setItem('friends', JSON.stringify(friends));
    channel.postMessage({type:'addFriend', friend:newFriend});
    return true;
  }
  return false;
}

// Scan QR
const qrCodeReader = new Html5Qrcode("reader");
qrCodeReader.start(
  { facingMode: "environment" },
  { fps:10, qrbox:250 },
  async (decodedText) => {
    try {
      const data = JSON.parse(decodedText);
      if(data.name){
        // Attempt Bluetooth connection
        try {
          const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices:true,
            optionalServices:['0000ffe0-0000-1000-8000-00805f9b34fb']
          });
          messageDiv.style.color = 'green';
          messageDiv.innerText = addFriendObject(data.name, data.profile || defaultProfile) 
            ? `Friend ${data.name} added!` : 'Friend already exists';
          qrCodeReader.stop();
        } catch(btErr){
          messageDiv.style.color = 'red';
          messageDiv.innerText = 'Bluetooth connection failed: No user found';
        }
      } else {
        messageDiv.style.color = 'red';
        messageDiv.innerText = 'No user found';
      }
    } catch(err){
      messageDiv.style.color = 'red';
      messageDiv.innerText = 'No user found';
    }
  },
  (err) => { /* scan errors ignored */ }
);

// Stop button
document.getElementById('stopBtn').addEventListener('click', () => {
  qrCodeReader.stop();
  messageDiv.style.color = 'black';
  messageDiv.innerText = 'Scan stopped';
});
</script>
</body>
</html>
