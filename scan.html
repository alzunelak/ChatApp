<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scan Code</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f5f5f5; }
#reader { width:300px; margin:auto; }
#message { margin-top:20px; font-size:16px; color:red; }
</style>
</head>
<body>
<h2>Scan Friend QR Code</h2>
<div id="reader"></div>
<div id="message"></div>

<script>
const messageDiv = document.getElementById('message');
const channel = new BroadcastChannel('chatapp');

// Default profile picture
const defaultProfile = "default-profile.png";

const qrCodeReader = new Html5Qrcode("reader");
qrCodeReader.start(
  { facingMode: "environment" },
  { fps:10, qrbox:250 },
  (decodedText) => {
    try {
      // Expect JSON data like: {"name":"Mimah","profile":"mimah.png"}
      const friendData = JSON.parse(decodedText);

      if(friendData.name){
        messageDiv.style.color = "green";
        messageDiv.innerText = "Friend found! Adding...";

        // Add friend to localStorage
        let friends = JSON.parse(localStorage.getItem('friends') || '[]');
        if(!friends.some(f => f.name === friendData.name)){
          // if no profile provided, fallback to default
          if(!friendData.profile) friendData.profile = defaultProfile;

          friends.push(friendData);
          localStorage.setItem('friends', JSON.stringify(friends));

          // Send full friend object to home
          channel.postMessage({type:'addFriend', friend: friendData});
        }

        qrCodeReader.stop().then(() => {
          messageDiv.innerText = `Friend "${friendData.name}" added!`;
        });
      } else {
        messageDiv.style.color = "red";
        messageDiv.innerText = "Invalid QR code (missing name)";
      }
    } catch(e){
      messageDiv.style.color = "red";
      messageDiv.innerText = "Invalid QR code format";
    }
  },
  (err) => { console.log(err); }
);
</script>
</body>
</html>
