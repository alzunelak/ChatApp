<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat - ChatApp</title>
<style>
  :root{--accent:#4CAF50;--bg:#f5f5f5;--card:#fff}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);height:100vh;display:flex;flex-direction:column}
  .top{display:flex;align-items:center;gap:12px;padding:14px;background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .top img{width:44px;height:44px;border-radius:50%}
  .top .title{font-weight:700}
  .content{flex:1;display:flex;height:calc(100vh - 160px)}
  .friends-col{width:32%;min-width:220px;background:var(--card);padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:auto}
  .friend-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;cursor:pointer}
  .friend-item:hover{background:#f0f0f0}
  .friend-item img{width:40px;height:40px;border-radius:50%}
  .chat-col{flex:1;display:flex;flex-direction:column;padding:12px}
  .chat-window{flex:1;background:var(--card);padding:12px;border-radius:10px;overflow:auto;box-shadow:0 1px 3px rgba(0,0,0,.04)}
  .msg{max-width:70%;margin:8px 0;padding:8px 10px;border-radius:10px;line-height:1.2}
  .msg.me{background:var(--accent);color:#fff;margin-left:auto;border-bottom-right-radius:2px}
  .msg.them{background:#eee;color:#222;border-bottom-left-radius:2px}
  .composer{display:flex;gap:8px;margin-top:10px}
  .composer input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
  .composer button{padding:10px 14px;border:none;background:var(--accent);color:#fff;border-radius:8px;cursor:pointer}
  .no-selection{flex:1;display:flex;align-items:center;justify-content:center;color:#666}
  .bottom-bar{display:flex;gap:8px;padding:12px;background:var(--card);box-shadow:0 -1px 3px rgba(0,0,0,.06);align-items:center;justify-content:space-between}
  .nav-links a{margin-right:8px;color:var(--accent);text-decoration:none}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>

<header class="top">
  <a href="home.html" style="text-decoration:none;color:inherit">
    <img id="profileImage" src="default-icon.png" alt="You">
  </a>
  <div>
    <div class="title" id="headerTitle">Chats</div>
    <div class="small">Tap a friend to open chat</div>
  </div>
  <div style="margin-left:auto" class="nav-links">
    <a href="search.html">Search</a>
    <a href="group.html">Group</a>
  </div>
</header>

<div class="content">
  <aside class="friends-col" id="friendsCol"></aside>

  <main class="chat-col">
    <div id="chatWindowArea" class="chat-window no-selection">
      Select a friend to open chat
    </div>
    <div class="composer" id="composer" style="display:none">
      <input id="messageInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>

<footer class="bottom-bar">
  <div class="small">Logged as: <strong id="footerName">Guest</strong></div>
  <div>
    <a href="home.html">Home</a> â€¢
    <a href="call.html">Call</a>
  </div>
</footer>

<script>
/* Load stored name & image */
const storedName = localStorage.getItem("userName");
const storedImage = localStorage.getItem("userImage");

if (storedName) {
  document.getElementById("headerTitle").textContent = storedName;
  document.getElementById("footerName").textContent = storedName;
}
if (storedImage) {
  document.getElementById("profileImage").src = storedImage;
}

/* Existing chat code */
const friendsKey = 'chatapp_friends';
const friendsCol = document.getElementById('friendsCol');
const chatWindowArea = document.getElementById('chatWindowArea');
const composer = document.getElementById('composer');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');

let friends = [];
let activeFriend = null;

function loadFriends(){
  const raw = localStorage.getItem(friendsKey);
  friends = raw ? JSON.parse(raw) : [];
  renderFriends();
}
function saveFriends(){ localStorage.setItem(friendsKey, JSON.stringify(friends)) }

function renderFriends(){
  friendsCol.innerHTML = '';
  if(friends.length===0){
    friendsCol.innerHTML = '<div class="small">No friends yet. Add from Home or Search page.</div>';
    return;
  }
  friends.forEach(name=>{
    const el = document.createElement('div');
    el.className = 'friend-item';
    el.innerHTML = `<img src="friend.png" alt=""><div>${name}</div>`;
    el.onclick = ()=> openChat(name);
    friendsCol.appendChild(el);
  });
}

function chatKey(name){ return 'chatapp_chat_' + name; }
function loadChat(name){
  const raw = localStorage.getItem(chatKey(name));
  return raw ? JSON.parse(raw) : [];
}
function saveChat(name, arr){ localStorage.setItem(chatKey(name), JSON.stringify(arr)); }

function openChat(name){
  activeFriend = name;
  composer.style.display = 'flex';
  renderChat();
}
function renderChat(){
  if(!activeFriend){
    chatWindowArea.innerHTML = 'Select a friend to open chat';
    chatWindowArea.classList.add('no-selection');
    composer.style.display = 'none';
    return;
  }
  chatWindowArea.classList.remove('no-selection');
  const messages = loadChat(activeFriend);
  chatWindowArea.innerHTML = '';
  messages.forEach(m=>{
    const d = document.createElement('div');
    d.className = 'msg ' + (m.from === 'me' ? 'me' : 'them');
    d.textContent = m.text;
    chatWindowArea.appendChild(d);
  });
  chatWindowArea.scrollTop = chatWindowArea.scrollHeight;
}

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });

function sendMessage(){
  const txt = messageInput.value.trim();
  if(!txt || !activeFriend) return;
  const arr = loadChat(activeFriend);
  arr.push({from:'me', text:txt, ts:Date.now()});
  saveChat(activeFriend, arr);
  messageInput.value = '';
  renderChat();
  setTimeout(()=>{
    const arr2 = loadChat(activeFriend);
    arr2.push({from:'them', text:'Thanks! (auto reply)', ts:Date.now()});
    saveChat(activeFriend, arr2);
    renderChat();
  }, 700);
}

loadFriends();
renderChat();

(function checkOpenParam(){
  const params = new URLSearchParams(location.search);
  const open = params.get('open');
  if(open){
    if(!friends.includes(open)){ friends.push(open); saveFriends(); renderFriends(); }
    openChat(open);
  }
})();
</script>
</body>
</html>
