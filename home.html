<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatApp Home</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial,sans-serif; margin:0; background:#f5f5f5; display:flex; flex-direction:column; height:100vh;}
  .profile-section{display:flex; align-items:center; justify-content:space-between; padding:20px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  .profile-info{display:flex; align-items:center; gap:15px;}
  .profile-info img{width:60px; height:60px; border-radius:50%; cursor:pointer;}
  .profile-info .name{font-size:20px; font-weight:bold;}
  .three-dot{font-size:24px; cursor:pointer;}
  .middle-section{flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; font-size:18px; color:#666;}
  .friends-list{margin-top:20px; width:80%;}
  .friend{background:#fff; padding:10px; margin-bottom:10px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; align-items:center;}
  .friend img{width:40px; height:40px; border-radius:50%; margin-right:10px;}
  .fab{position:fixed; bottom:100px; right:30px; width:60px; height:60px; background:#4CAF50; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:36px; color:#fff; cursor:pointer; box-shadow:0 3px 6px rgba(0,0,0,0.2); z-index:100;}
  .popup-menu{position:fixed; bottom:170px; right:30px; background:#fff; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.2); display:none; flex-direction:column; overflow:hidden; z-index:99;}
  .popup-menu button{padding:15px 20px; border:none; background:none; text-align:left; cursor:pointer; font-size:16px; width:200px;}
  .popup-menu button:hover{background:#f0f0f0;}
  .chat-group-call{display:flex; justify-content:space-around; padding:15px; background:#fff; box-shadow:0 -2px 5px rgba(0,0,0,0.1);}
  .chat-group-call button{padding:10px 15px; font-size:16px; border:none; border-radius:8px; cursor:pointer; background:#4CAF50; color:#fff;}
  #qr-reader{width:100%; max-width:400px; margin-top:20px;}
</style>
</head>
<body>

<!-- Profile Section -->
<div class="profile-section">
  <div class="profile-info">
    <img id="profilePhoto" src="default-profile.png" alt="Profile Picture">
    <div class="name" id="profileName"></div>
  </div>
  <div class="three-dot">â‹®</div>
</div>

<!-- Middle Section -->
<div class="middle-section">
  No messages yet, add friends
  <div class="friends-list" id="friendsList"></div>
</div>

<!-- Floating + Button -->
<div class="fab" id="fab">+</div>

<!-- Popup Menu -->
<div class="popup-menu" id="popupMenu">
  <button id="myCodeBtn">My Code</button>
  <button id="scanCodeBtn">Scan Code</button>
  <button id="searchFriendBtn">Search Friend</button>
  <button id="videoPhotoBtn">Take Video & Photo</button>
</div>

<!-- Bottom Chat / Group / Call -->
<div class="chat-group-call">
  <button id="chatBtn">Chat</button>
  <button id="groupBtn">Group</button>
  <button id="callBtn">Call</button>
</div>

<!-- QR Reader -->
<div id="qr-reader" style="display:none;"></div>

<script>
  // --- Profile Name & Photo ---
  const profileNameEl = document.getElementById('profileName');
  const profilePhotoEl = document.getElementById('profilePhoto');

  function loadProfile() {
    let name = localStorage.getItem('chatapp_username');
    let photo = localStorage.getItem('chatapp_userphoto');

    if(!name){
      name = prompt("Enter your name:") || "User";
      localStorage.setItem('chatapp_username', name);
    }

    if(!photo){
      photo = 'default-profile.png';
      localStorage.setItem('chatapp_userphoto', photo);
    }

    profileNameEl.textContent = name;
    profilePhotoEl.src = photo;
  }

  loadProfile();

  // Upload new profile photo
  profilePhotoEl.addEventListener('click', ()=>{
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.onchange = e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(evt){
        profilePhotoEl.src = evt.target.result;
        localStorage.setItem('chatapp_userphoto', evt.target.result);
      }
      reader.readAsDataURL(file);
    }
    fileInput.click();
  });

  // --- Friends ---
  const fab = document.getElementById('fab');
  const popupMenu = document.getElementById('popupMenu');
  const friendsList = document.getElementById('friendsList');
  let html5QrcodeScanner;

  fab.addEventListener('click', () => {
    popupMenu.style.display = popupMenu.style.display === 'flex' ? 'none' : 'flex';
  });

  function getSavedFriends() {
    const saved = localStorage.getItem('chatapp_friends');
    return saved ? JSON.parse(saved) : [];
  }

  function saveFriends(friends){
    localStorage.setItem('chatapp_friends', JSON.stringify(friends));
  }

  function renderFriends(){
    friendsList.innerHTML = '';
    const friends = getSavedFriends();
    friends.forEach(name=>{
      const friendDiv = document.createElement('div');
      friendDiv.className = 'friend';
      friendDiv.innerHTML = `<img src="friend.png" alt="Friend"> ${name}`;
      friendsList.appendChild(friendDiv);
    });
  }

  function addFriend(name){
    if(!name) return;
    const friends = getSavedFriends();
    if(!friends.includes(name)){
      friends.push(name);
      saveFriends(friends);
      renderFriends();
    }
  }

  renderFriends(); // Load saved friends on page load

  // --- Popup Menu Buttons ---
  document.getElementById('myCodeBtn').addEventListener('click', ()=>{
    alert("Show my QR code for others to scan!");
  });

  document.getElementById('scanCodeBtn').addEventListener('click', ()=>{
    const qrReaderDiv = document.getElementById('qr-reader');
    qrReaderDiv.style.display = 'block';
    html5QrcodeScanner = new Html5Qrcode("qr-reader");

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      decodedText => {
        addFriend(decodedText);
        html5QrcodeScanner.stop();
        qrReaderDiv.style.display = 'none';
      },
      errorMessage => {}
    ).catch(err => alert("Unable to start QR scanner: " + err));
  });

  document.getElementById('searchFriendBtn').addEventListener('click', ()=>{
    const friendName = prompt("Enter friend's name to add:");
    if(friendName) addFriend(friendName);
  });

  document.getElementById('videoPhotoBtn').addEventListener('click', ()=>{
    const video = document.createElement('video');
    video.style.width = '100%';
    video.style.height = '100%';
    video.autoplay = true;
    document.body.appendChild(video);

    navigator.mediaDevices.getUserMedia({ video:true })
      .then(stream => video.srcObject = stream)
      .catch(err => alert("Error accessing camera: " + err));
  });

  // --- Chat / Group / Call Buttons ---
  document.getElementById('chatBtn').addEventListener('click', ()=> window.location.href='chat.html');
  document.getElementById('groupBtn').addEventListener('click', ()=> window.location.href='group.html');
  document.getElementById('callBtn').addEventListener('click', ()=> window.location.href='call.html');
</script>

</body>
</html>
