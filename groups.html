<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Groups</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {
  font-family: Arial, sans-serif;
  margin:0;
  padding:20px;
  background:#000;
  color:#fff;
}
h1 { margin-bottom: 10px; }

button#createGroupBtn {
  padding: 10px 15px;
  background:#25d366;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:10px;
}

.group {
  display:flex;
  align-items:center;
  background:#111;
  padding:10px;
  margin:10px 0;
  border-radius:8px;
  cursor:pointer;
  position:relative;
}

.group img {
  width:50px;
  height:50px;
  border-radius:50%;
  margin-right:10px;
  object-fit:cover;
}

.group .info { flex:1; }
.group .info h3 { margin:0; font-size:16px; }
.group .info p { margin:0; font-size:12px; color:gray; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.red-dot {
  position:absolute;
  right:40px;
  top:15px;
  width:10px;
  height:10px;
  background:red;
  border-radius:50%;
}

/* Three-dot menu button at top-right */
.group .moreBtn {
  position: absolute;
  right: 10px;
  top: 5px;  /* top of group box */
  font-size: 18px;
  cursor: pointer;
  color: #25d366;
}

/* Dropdown menu */
.group .dropdown {
  display:none;
  position:absolute;
  top:25px;   /* slightly below the button */
  right:10px;
  background:#000;
  border:1px solid #25d366;
  box-shadow:0 0 10px #25d366;
  border-radius:8px;
  flex-direction:column;
  z-index:100;
}

.group .dropdown button {
  background:#000;
  color:#fff;
  border:none;
  padding:8px 12px;
  cursor:pointer;
  text-align:left;
  border-bottom:1px solid #25d366;
}
.group .dropdown button:last-child { border-bottom:none; }
.group .dropdown button:hover { background:#25d366; color:#000; }

/* Back arrow */
.backArrow {
  position: absolute;
  left: 20px;
  top: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #25d366;
}

/* NEW GROUP POPUP */
#newGroupPopup {
  display:none;
  position:absolute;
  top:50px;
  left:50%;
  transform:translateX(-50%);
  background:black;
  color:#fff;
  padding:15px;
  border-radius:8px;
  box-shadow: 0 0 15px #25d366;
  flex-direction:column;
}
#newGroupPopup input {
  width:200px;
  margin-bottom:10px;
  padding:5px;
}
#newGroupPopup button { padding:5px 10px; margin-right:5px; }
</style>
</head>
<body>

<i class="fas fa-arrow-left backArrow" onclick="goBack()"></i>
<h1>My Groups</h1>
<button id="createGroupBtn">+ Create Group</button>
<div id="groupsList"></div>

<div id="newGroupPopup">
  <h3>New Group</h3>
  <input type="text" id="newGroupName" placeholder="Group Name"><br>
  <input type="file" id="newGroupPhoto" accept="image/*"><br>
  <div style="display:flex;">
    <button onclick="createGroup()">Create</button>
    <button onclick="closeNewGroupPopup()">Cancel</button>
  </div>
</div>

<script>
const myName = "You";
let groups = JSON.parse(localStorage.getItem("groups") || "[]");

const groupsListDiv = document.getElementById("groupsList");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupPopup = document.getElementById("newGroupPopup");

createGroupBtn.onclick = () => { newGroupPopup.style.display = "flex"; };
function closeNewGroupPopup() { newGroupPopup.style.display = "none"; }

function renderGroups(){
  groups = JSON.parse(localStorage.getItem("groups") || "[]");
  groupsListDiv.innerHTML = "";

  const myGroups = groups.filter(g => g.members.some(m=>m.name === myName));

  myGroups.sort((a,b)=>{
    const aTime = a.messages && a.messages.length ? new Date(a.messages[a.messages.length-1].time).getTime() : 0;
    const bTime = b.messages && b.messages.length ? new Date(b.messages[b.messages.length-1].time).getTime() : 0;
    return bTime - aTime;
  });

  myGroups.forEach((g,index)=>{
    const div = document.createElement("div");
    div.className = "group";
    div.innerHTML = `
      <img src="${g.photo || 'group.png'}">
      <div class="info">
        <h3>${g.name}</h3>
        <p title="${g.messages && g.messages.length ? g.messages[g.messages.length-1].text : 'No messages yet'}">
          ${g.messages && g.messages.length ? (g.messages[g.messages.length-1].text.slice(0,20)+'...') : 'No messages yet'}
        </p>
      </div>
      ${g.unread ? '<div class="red-dot"></div>' : ''}
      <i class="fas fa-ellipsis-v moreBtn"></i>
      <div class="dropdown">
        <button onclick="leaveGroup(${index})">Leave Group</button>
        <button onclick="blockGroup(${index})">Block Group</button>
      </div>
    `;
    groupsListDiv.appendChild(div);

    // Group click opens chat
    div.querySelector('.info').onclick = () => {
      g.unread = false;
      groups = groups.map(gr=>gr.name===g.name ? g : gr);
      localStorage.setItem("groups",JSON.stringify(groups));
      localStorage.setItem("currentGroupIndex", index);
      window.location = "group-chat.html";
    };

    // Toggle dropdown
    const moreBtn = div.querySelector('.moreBtn');
    const dropdown = div.querySelector('.dropdown');
    moreBtn.onclick = (e) => {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
    };

    // Close dropdown if clicking outside
    document.addEventListener('click', ()=> { dropdown.style.display='none'; });
  });
}

// Leave group function
function leaveGroup(index){
  if(confirm("Are you sure you want to leave this group?")){
    groups[index].members = groups[index].members.filter(m=>m.name!==myName);
    localStorage.setItem("groups",JSON.stringify(groups));
    renderGroups();
  }
}

// Block group function
function blockGroup(index){
  if(confirm("Are you sure you want to block this group?")){
    if(!groups[index].blocked.includes(myName)) groups[index].blocked.push(myName);
    localStorage.setItem("groups",JSON.stringify(groups));
    renderGroups();
  }
}

// Create new group
function createGroup(){
  const name = document.getElementById("newGroupName").value.trim();
  if(!name){ alert("Enter a group name!"); return; }

  const fileInput = document.getElementById("newGroupPhoto");
  if(fileInput.files && fileInput.files[0]){
    const reader = new FileReader();
    reader.onload = e => saveGroup(name,e.target.result);
    reader.readAsDataURL(fileInput.files[0]);
  } else saveGroup(name,"group.png");
}

function saveGroup(name,img){
  const newGroup = { name, photo: img, admin: myName, members:[{name:myName,accepted:true}], invited:[], blocked:[], messages:[], unread:false };
  groups.push(newGroup);
  localStorage.setItem("groups",JSON.stringify(groups));
  renderGroups();
  closeNewGroupPopup();
  document.getElementById("newGroupName").value="";
  document.getElementById("newGroupPhoto").value="";
}
function goBack() {
  window.history.back();
}

window.addEventListener('storage', renderGroups);
renderGroups();
</script>
</body>
</html>
