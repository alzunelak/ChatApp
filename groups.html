<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Groups</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body {
  font-family: Arial, sans-serif;
  margin:0;
  padding:20px;
  background:#000;
  color:#fff;
  position: relative;
}
h1 { margin-bottom: 10px; }

/* Top-left back arrow */
.backArrow {
  position: absolute;
  left: 20px;
  top: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #fff;
}

/* Top-right three-dot */
.topMoreBtn {
  position: absolute;
  right: 20px;
  top: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #fff;
  z-index: 200;
}

/* Dropdown for top menu */
.dropdownTop {
  display: none;
  position: absolute;
  top: 60px;
  right: 20px;
  background: #000;
  border: 1px solid #25d366;
  border-radius: 8px;
  flex-direction: column;
  z-index: 200;
}
.dropdownTop button {
  background: #000;
  color: #fff;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  text-align: left;
  border-bottom: 1px solid #25d366;
}
.dropdownTop button:last-child { border-bottom:none; }
.dropdownTop button:hover { background:#25d366; color:#000; }

/* Create group button */
button#createGroupBtn {
  padding: 10px 15px;
  background:#25d366;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-bottom:10px;
}

/* Group cards */
.group {
  display:flex;
  align-items:center;
  background:#111;
  padding:10px;
  margin:10px 0;
  border-radius:8px;
  cursor:pointer;
  position:relative;
}
.group img {
  width:50px;
  height:50px;
  border-radius:50%;
  margin-right:10px;
  object-fit:cover;
}
.group .info { flex:1; }
.group .info h3 { margin:0; font-size:16px; }
.group .info p { margin:0; font-size:12px; color:gray; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.red-dot {
  position:absolute;
  right:10px;
  top:15px;
  width:10px;
  height:10px;
  background:red;
  border-radius:50%;
}

/* Bottom bar */
.bottomBar {
  display:flex;
  justify-content:space-around;
  align-items:center;
  padding:10px 0;
  background:#111;
  flex-shrink:0;
}
.bottomBar button {
  background:none;
  border:none;
  color:#25d366;
  font-size:20px;
  cursor:pointer;
}

  
/* NEW GROUP POPUP */
#newGroupPopup {
  display:none;
  position:absolute;
  top:100px;
  left:50%;
  transform:translateX(-50%);
  background:black;
  color:#fff;
  padding:15px;
  border-radius:8px;
  box-shadow: 0 0 15px #25d366;
  flex-direction:column;
}
#newGroupPopup input {
  width:200px;
  margin-bottom:10px;
  padding:5px;
}
#newGroupPopup button { padding:5px 10px; margin-right:5px; }
</style>
</head>
<body>

  <!-- Top-left back arrow -->
  <i class="fas fa-arrow-left backArrow" onclick="goBack()"></i>

  <!-- Top-right three-dot menu -->
  <i class="fas fa-ellipsis-v topMoreBtn" onclick="toggleTopMenu()"></i>
  <div id="topDropdown" class="dropdownTop">
    <button onclick="topOption1()">settings</button>
  </div>

<h1>My Groups</h1>
<button id="createGroupBtn">+ Create Group</button>
<div id="groupsList"></div>


<!-- Bottom bar -->
<div class="bottomBar">
  <button onclick="alert('Chat')"><chat"></i></button>
  <button onclick="alert('Groups')"><groups"></i></button>
  <button onclick="alert('Calls')"><calls"></i></button>
</div>
  
<div id="newGroupPopup">
  <h3>New Group</h3>
  <input type="text" id="newGroupName" placeholder="Group Name"><br>
  <input type="file" id="newGroupPhoto" accept="image/*"><br>
  <div style="display:flex;">
    <button onclick="createGroup()">Create</button>
    <button onclick="closeNewGroupPopup()">Cancel</button>
  </div>
</div>

<script>
const myName = "You";
let groups = JSON.parse(localStorage.getItem("groups") || "[]");

const groupsListDiv = document.getElementById("groupsList");
const createGroupBtn = document.getElementById("createGroupBtn");
const newGroupPopup = document.getElementById("newGroupPopup");

createGroupBtn.onclick = () => { newGroupPopup.style.display = "flex"; };
function closeNewGroupPopup() { newGroupPopup.style.display = "none"; }

function renderGroups(){
  groups = JSON.parse(localStorage.getItem("groups") || "[]");
  groupsListDiv.innerHTML = "";

  const myGroups = groups.filter(g => g.members.some(m=>m.name === myName));

  myGroups.sort((a,b)=>{
    const aTime = a.messages && a.messages.length ? new Date(a.messages[a.messages.length-1].time).getTime() : 0;
    const bTime = b.messages && b.messages.length ? new Date(b.messages[b.messages.length-1].time).getTime() : 0;
    return bTime - aTime;
  });

  myGroups.forEach((g,index)=>{
    const div = document.createElement("div");
    div.className = "group";
    div.innerHTML = `
      <img src="${g.photo || 'group.png'}">
      <div class="info">
        <h3>${g.name}</h3>
        <p title="${g.messages && g.messages.length ? g.messages[g.messages.length-1].text : 'No messages yet'}">
          ${g.messages && g.messages.length ? (g.messages[g.messages.length-1].text.slice(0,20)+'...') : 'No messages yet'}
        </p>
      </div>
      ${g.unread ? '<div class="red-dot"></div>' : ''}
    `;
    groupsListDiv.appendChild(div);

    // Group click opens chat
    div.querySelector('.info').onclick = () => {
      g.unread = false;
      groups = groups.map(gr=>gr.name===g.name ? g : gr);
      localStorage.setItem("groups",JSON.stringify(groups));
      localStorage.setItem("currentGroupIndex", index);
      window.location = "group-chat.html";
    };
  });
}

// Top menu toggle
function goToSettings() {
  window.location.href = "setting.html";
}

// Close top dropdown if clicking outside
document.addEventListener('click', (e) => {
  const dropdown = document.getElementById("topDropdown");
  const btn = document.querySelector('.topMoreBtn');
  if(!dropdown.contains(e.target) && !btn.contains(e.target)){
    dropdown.style.display = 'none';
  }
});

// Create new group
function createGroup(){
  const name = document.getElementById("newGroupName").value.trim();
  if(!name){ alert("Enter a group name!"); return; }

  const fileInput = document.getElementById("newGroupPhoto");
  if(fileInput.files && fileInput.files[0]){
    const reader = new FileReader();
    reader.onload = e => saveGroup(name,e.target.result);
    reader.readAsDataURL(fileInput.files[0]);
  } else saveGroup(name,"group.png");
}

function saveGroup(name,img){
  const newGroup = { name, photo: img, admin: myName, members:[{name:myName,accepted:true}], invited:[], blocked:[], messages:[], unread:false };
  groups.push(newGroup);
  localStorage.setItem("groups",JSON.stringify(groups));
  renderGroups();
  closeNewGroupPopup();
  document.getElementById("newGroupName").value="";
  document.getElementById("newGroupPhoto").value="";
}

function goBack() { window.history.back(); }

window.addEventListener('storage', renderGroups);
renderGroups();
</script>
</body>
</html>
