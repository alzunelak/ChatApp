// --- Attachment Menu Toggle ---
const attachmentToggle = document.getElementById('attachmentToggle');
const attachmentMenu = document.getElementById('attachmentMenu');

attachmentToggle.addEventListener('click', () => {
  attachmentMenu.style.display = (attachmentMenu.style.display === 'flex' || attachmentMenu.style.display === 'grid') ? 'none' : 'grid';
});

// Close menu function
function closeAttachmentMenu() {
  attachmentMenu.style.display = 'none';
}

// --- File ---
document.getElementById('sendFileBtn').addEventListener('click', () => {
  closeAttachmentMenu(); 
  const inputFile = document.createElement('input');
  inputFile.type = 'file';
  inputFile.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => sendAttachment('file', reader.result, file.name);
    reader.readAsDataURL(file);
  }
  inputFile.click();
});

// --- Photo ---
document.getElementById('takePhotoBtn').addEventListener('click', () => {
  closeAttachmentMenu();
  const choice = confirm("Press OK to take a photo with camera, Cancel to pick from gallery");
  const inputPhoto = document.createElement('input');
  inputPhoto.type = 'file';
  inputPhoto.accept = 'image/*';
  if (choice) inputPhoto.capture = 'environment';
  inputPhoto.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => sendAttachment('photo', reader.result, file.name);
    reader.readAsDataURL(file);
  };
  inputPhoto.click();
});

// --- Video ---
document.getElementById('takeVideoBtn').addEventListener('click', () => {
  closeAttachmentMenu();
  const choice = confirm("Press OK to record video, Cancel to pick from gallery");
  const inputVideo = document.createElement('input');
  inputVideo.type = 'file';
  inputVideo.accept = 'video/*';
  if (choice) inputVideo.capture = 'camcorder';
  inputVideo.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => sendAttachment('video', reader.result, file.name);
    reader.readAsDataURL(file);
  };
  inputVideo.click();
});

// --- Location ---
document.getElementById('sendLocationBtn').addEventListener('click', () => {
  closeAttachmentMenu();
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(pos => {
    const url = `https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
    sendAttachment('text', url, 'My Location');
  }, err => alert("Location error: " + err.message));
});

// --- Send Attachment Function ---
function sendAttachment(type, data, name) {
  const msg = {
    senderId: myId,
    senderName: myName,
    profile: myPic,
    recipient: friend,
    type: type,
    data: data,
    text: name || "",
    time: formatTime()
  };

  const messages = getChat();
  messages.push(msg);
  saveChat(messages);
  loadChat();

  socket.emit("private message", msg);
}

// --- Video Call ---
document.getElementById('startVideoCallBtn').addEventListener('click', () => {
  closeAttachmentMenu();
  socket.emit('start video call', { from: myId, to: friend });
  alert('Video call initiated');
});

// --- Audio Call ---
document.getElementById('startAudioCallBtn').addEventListener('click', () => {
  closeAttachmentMenu();
  socket.emit('start audio call', { from: myId, to: friend });
  alert('Audio call initiated');
});
