<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group Chat</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    .header { background:#4CAF50; color:#fff; padding:10px; display:flex; align-items:center; }
    .header h2 { flex:1; margin:0; }
    .chat-box { height:300px; overflow-y:auto; padding:10px; border:1px solid #ccc; }
    .msg { margin:5px 0; }
    .msg.self { text-align:right; }
    .input-area { display:flex; padding:10px; border-top:1px solid #ccc; }
    .input-area input { flex:1; padding:8px; }
    .input-area button { padding:8px; }
    .tabs { display:flex; border-bottom:1px solid #ccc; }
    .tabs button { flex:1; padding:10px; cursor:pointer; }
    .tab-content { display:none; padding:10px; }
    .tab-content.active { display:block; }
    .member, .friend { display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; }
    .member button, .friend button { margin-left:5px; }
    .top-bar { display:flex; align-items:center; margin-bottom:10px; }
    .back { cursor:pointer; margin-right:10px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="back" onclick="window.location='groups.html'">â¬… Back</div>
    <h2 id="groupName">Group</h2>
  </div>

  <div class="tabs">
    <button onclick="showTab('chat')">Chat</button>
    <button onclick="showTab('members')">Members</button>
    <button onclick="showTab('blocked')">Blocked</button>
  </div>

  <div id="chat" class="tab-content active">
    <div id="chatBox" class="chat-box"></div>
    <div class="input-area">
      <input id="msgInput" placeholder="Type a message...">
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <div id="members" class="tab-content">
    <div class="top-bar"><h3>Group Members</h3></div>
    <div id="memberList"></div>
    <h4>Add Friends</h4>
    <div id="friendList"></div>
  </div>

  <div id="blocked" class="tab-content">
    <h3>Blocked Users</h3>
    <div id="blockedList"></div>
  </div>

  <script>
    // ===== STATE =====
    let currentUser = "You";
    let groups = JSON.parse(localStorage.getItem("groups") || "[]");
    let groupIndex = parseInt(localStorage.getItem("currentGroupIndex") || "-1");

    if (groupIndex < 0 || !groups[groupIndex]) {
      window.location.href = "groups.html";
    }

    let currentGroup = groups[groupIndex];
    let messages = currentGroup.messages || [];
    let blockedMembers = currentGroup.blocked || [];
    let allFriends = JSON.parse(localStorage.getItem("friends") || "[]");

    document.getElementById("groupName").textContent = currentGroup.name;

    // ===== TABS =====
    function showTab(id){
      document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // ===== CHAT =====
    function renderMessages(){
      const chatBox=document.getElementById("chatBox");
      chatBox.innerHTML="";
      messages.forEach(m=>{
        if(blockedMembers.includes(m.user)) return;
        const div=document.createElement("div");
        div.className="msg"+(m.user===currentUser?" self":"");
        div.innerHTML=`<div><b>${m.user}:</b> ${m.text}</div><div class="meta">${m.time}</div>`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function sendMsg(){
      const msgInput=document.getElementById("msgInput");
      const txt=msgInput.value.trim();
      if(!txt) return;
      const newMsg = {id:Date.now(), text:txt, user:currentUser, time:new Date().toLocaleTimeString()};
      messages.push(newMsg);
      currentGroup.messages = messages;
      saveGroup();
      renderMessages();
      msgInput.value="";
    }

    // ===== MEMBERS =====
    function renderMembers(){
      const list=document.getElementById("memberList");
      list.innerHTML="";
      currentGroup.members.forEach(m=>{
        const div=document.createElement("div");
        div.className="member";
        div.innerHTML=`<span>${m.name}</span>`;
        if(m.name!==currentUser){
          const remove=document.createElement("button");
          remove.textContent="Remove";
          remove.onclick=()=>{
            currentGroup.members=currentGroup.members.filter(mem=>mem.name!==m.name);
            saveGroup(); renderMembers();
          };
          const block=document.createElement("button");
          block.textContent="Block";
          block.onclick=()=>{
            blockedMembers.push(m.name);
            currentGroup.blocked=blockedMembers;
            saveGroup(); renderBlocked();
          };
          div.appendChild(remove); div.appendChild(block);
        }
        list.appendChild(div);
      });
    }

    // ===== ADD FRIENDS =====
    function renderFriends(){
      const fl=document.getElementById("friendList");
      fl.innerHTML="";
      let memberNames=currentGroup.members.map(m=>m.name);
      let available=allFriends.filter(f=>!memberNames.includes(f));
      if(available.length===0){ fl.innerHTML="No friends to add"; return; }
      available.forEach(f=>{
        const div=document.createElement("div");
        div.className="friend";
        div.innerHTML=`<span>${f}</span>`;
        const add=document.createElement("button");
        add.textContent="Add";
        add.onclick=()=>{
          currentGroup.members.push({name:f});
          saveGroup(); renderMembers(); renderFriends();
        };
        div.appendChild(add);
        fl.appendChild(div);
      });
    }

    // ===== BLOCKED =====
    function renderBlocked(){
      const bl=document.getElementById("blockedList");
      bl.innerHTML="";
      if(blockedMembers.length===0){ bl.innerHTML="No blocked users"; return; }
      blockedMembers.forEach(b=>{
        const div=document.createElement("div");
        div.textContent=b;
        const unblock=document.createElement("button");
        unblock.textContent="Unblock";
        unblock.onclick=()=>{
          blockedMembers=blockedMembers.filter(x=>x!==b);
          currentGroup.blocked=blockedMembers;
          saveGroup(); renderBlocked();
        };
        div.appendChild(unblock);
        bl.appendChild(div);
      });
    }

    // ===== SAVE =====
    function saveGroup(){
      groups[groupIndex]=currentGroup;
      localStorage.setItem("groups",JSON.stringify(groups));
    }

    // ===== INIT =====
    renderMessages();
    renderMembers();
    renderFriends();
    renderBlocked();
  </script>
</body>
</html>
