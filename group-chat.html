<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Chat</title>
<style>
body{font-family:Arial;margin:0;background:#e5ddd5;}
.header{background:#25d366;color:white;text-align:center;padding:10px;position:relative;}
.header img{width:80px;height:80px;border-radius:50%;margin-top:5px;cursor:pointer;}
.header h2{margin:5px 0;cursor:pointer;}
#members{display:flex;flex-wrap:wrap;justify-content:center;margin:5px;}
#members div{background:#128C7E;color:white;padding:5px 10px;border-radius:15px;margin:2px;position:relative;}
#members div span{cursor:pointer;margin-left:5px;}
#chatBox{height:400px;overflow-y:auto;padding:10px;background:#ece5dd;margin:10px;border-radius:8px;display:flex;flex-direction:column;}
.msg{background:white;padding:8px 12px;margin:5px 0;border-radius:12px;display:flex;align-items:flex-start;max-width:70%;word-wrap:break-word;}
.msg.self{background:#dcf8c6;align-self:flex-end;}
.msg strong{margin-right:5px;}
.msg img, .msg video{border-radius:12px;max-width:200px;max-height:200px;margin-top:5px;}
#inputArea{display:flex;padding:10px;background:white;border-radius:25px;margin:10px;align-items:center;position:relative;}
#inputArea input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;}
#inputArea button{margin-left:5px;padding:10px 12px;border:none;border-radius:50%;background:#25d366;color:white;cursor:pointer;}
#topAdd{position:absolute;right:10px;top:10px;cursor:pointer;font-size:20px;background:white;color:#25d366;border-radius:6px;padding:3px 6px;}
#attachmentMenu {
  display:none;
  flex-direction:column;
  position:absolute;
  bottom:60px; /* pop above button */
  right:15px;
  background:white;
  padding:10px;
  border-radius:10px;
  box-shadow:0 0 5px #888;
  z-index:100;
}
#attachmentMenu button {
  padding:8px 12px;
  border:none;
  border-radius:6px;
  background:#128C7E;
  color:white;
  cursor:pointer;
  flex:1;
}
#attachmentMenu button:hover { background:#0d6b61; }
</style>
</head>
<body>

<div class="header">
  <h2 id="groupName"></h2>
  <img id="groupPhoto" src="">
  <div id="members"></div>
  <div id="topAdd">Add</div>
</div>

<div id="chatBox"></div>

<div id="inputArea">
  <input id="msgInput" placeholder="Type a message...">
  <button id="sendBtn">‚û§</button>
  <button id="attachmentToggle">+</button>
</div>

<!-- Attachment menu -->
<div id="attachmentMenu">
  <div style="display:flex; gap:6px; margin-bottom:6px;">
    <button id="sendFileBtn">üìé File</button>
    <button id="takePhotoBtn">üñºÔ∏è Photo</button>
    <button id="takeVideoBtn">üé• Video</button>
  </div>
  <div style="display:flex; gap:6px;">
    <button id="audioCallBtn">üìû Audio Call</button>
    <button id="videoCallBtn">üé• Video Call</button>
    <button id="sendLocationBtn">üìç Location</button>
  </div>
</div>

<script>
let groups = JSON.parse(localStorage.getItem("groups")||"[]");
let currentIndex = localStorage.getItem("currentGroupIndex");
let group = groups[currentIndex];
const myName="You";

const chatBox=document.getElementById("chatBox");

// Render members
function renderMembers(){
  const div=document.getElementById("members");
  div.innerHTML="";
  group.members.filter(m=>m.accepted).forEach(m=>{
    const mDiv=document.createElement("div");
    mDiv.textContent=m.name;
    if(group.admin===myName && m.name!==myName){
      const blockSpan=document.createElement("span");
      blockSpan.textContent = group.blocked.includes(m.name) ? "üö´" : "‚≠ï";
      blockSpan.onclick=()=>blockMember(m.name);
      mDiv.appendChild(blockSpan);
    }
    div.appendChild(mDiv);
  });
}

function blockMember(name){
  if(group.blocked.includes(name)){
    group.blocked=group.blocked.filter(x=>x!==name);
  } else {
    group.blocked.push(name);
  }
  saveGroup();
  renderMembers();
  renderMessages();
  checkBlockedStatus();
}

// Render messages
function renderMessages(){
  chatBox.innerHTML="";
  group.messages.forEach(m=>{
    if(group.blocked.includes(m.sender)) return;
    const div=document.createElement("div");
    div.className="msg"+(m.sender===myName?" self":"");
    let content = `<strong>${m.sender}:</strong> `;
    if(m.type==="photo") content += `<img src="${m.data}">`;
    else if(m.type==="video") content += `<video src="${m.data}" controls></video>`;
    else content += m.text;
    div.innerHTML = content;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

// Send text
document.getElementById("sendBtn").onclick=()=>{
  const txt=document.getElementById("msgInput").value.trim();
  if(!txt) return;
  if(group.blocked.includes(myName)) return;
  group.messages.push({sender:myName,text:txt,type:"text"});
  document.getElementById("msgInput").value="";
  saveGroup();
  renderMessages();
};

// Check block status
function checkBlockedStatus() {
  const input = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  if (group.blocked.includes(myName)) {
    input.disabled = true;
    input.placeholder = "‚ùå You are blocked";
    sendBtn.disabled = true;
    sendBtn.style.opacity = "0.5";
  } else {
    input.disabled = false;
    input.placeholder = "Type a message...";
    sendBtn.disabled = false;
    sendBtn.style.opacity = "1";
  }
}

// --- Attachment Menu ---
const attachmentToggle = document.getElementById('attachmentToggle');
const attachmentMenu = document.getElementById('attachmentMenu');
attachmentToggle.addEventListener('click', () => {
  attachmentMenu.style.display = (attachmentMenu.style.display==='flex') ? 'none' : 'flex';
});
function closeAttachmentMenu() { attachmentMenu.style.display='none'; }

// --- File ---
document.getElementById('sendFileBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const inputFile = document.createElement('input');
  inputFile.type='file';
  inputFile.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    group.messages.push({sender:myName,text:file.name,type:"file"});
    saveGroup(); renderMessages();
  }
  inputFile.click();
});

// --- Photo ---
document.getElementById('takePhotoBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const inputPhoto = document.createElement('input');
  inputPhoto.type = 'file';
  inputPhoto.accept = 'image/*';
  inputPhoto.capture = 'environment';
  inputPhoto.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      group.messages.push({sender:myName,type:"photo",data:reader.result});
      saveGroup(); renderMessages();
    }
    reader.readAsDataURL(file);
  };
  inputPhoto.click();
});

// --- Video ---
document.getElementById('takeVideoBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  const inputVideo = document.createElement('input');
  inputVideo.type = 'file';
  inputVideo.accept = 'video/*';
  inputVideo.capture = 'camcorder';
  inputVideo.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      group.messages.push({sender:myName,type:"video",data:reader.result});
      saveGroup(); renderMessages();
    }
    reader.readAsDataURL(file);
  };
  inputVideo.click();
});

// --- Location ---
document.getElementById('sendLocationBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  if(!navigator.geolocation) return alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const url = `https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
    group.messages.push({sender:myName,type:"text",text:`My Location: ${url}`});
    saveGroup(); renderMessages();
  }, err=>alert("Location error: "+err.message));
});

// --- Audio Call ---
document.getElementById('audioCallBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  group.messages.push({sender:myName,type:"text",text:"üìû Audio Call"});
  saveGroup(); renderMessages();
});

// --- Video Call ---
document.getElementById('videoCallBtn').addEventListener('click', ()=>{
  closeAttachmentMenu();
  group.messages.push({sender:myName,type:"text",text:"üé• Video Call"});
  saveGroup(); renderMessages();
});

// Save group
function saveGroup(){
  groups[currentIndex] = group;
  localStorage.setItem("groups",JSON.stringify(groups));
}

renderMembers();
renderMessages();
checkBlockedStatus();
</script>
</body>
</html>
