<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Chat</title>
<style>
body{font-family:Arial;margin:0;background:#e5ddd5;display:flex;flex-direction:column;height:100vh;}
header{background:#25d366;color:white;padding:10px;text-align:center;position:relative;}
header img{width:60px;height:60px;border-radius:50%;display:block;margin:0 auto;cursor:pointer;}
#groupName{margin:5px 0;cursor:pointer;}
#members{display:flex;flex-wrap:wrap;justify-content:center;margin-top:5px;gap:5px;}
#members div{background:#128C7E;color:white;padding:3px 8px;border-radius:12px;font-size:12px;}
#chatBox{flex:1;overflow-y:auto;padding:10px;}
.message{padding:8px;margin:5px 0;border-radius:8px;max-width:70%;display:flex;align-items:flex-end;}
.message.self{background:#dcf8c6;align-self:flex-end;}
.message img{width:30px;height:30px;border-radius:50%;margin-right:5px;}
#inputArea{display:flex;padding:10px;gap:5px;background:white;align-items:center;position:relative;}
#inputArea input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;}
#inputArea button, .icon{padding:10px;border:none;border-radius:50%;background:#25d366;color:white;cursor:pointer;}
#filePopup{display:none;position:absolute;bottom:60px;left:10px;background:white;padding:10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
#filePopup button{display:block;margin:5px 0;width:100%;}
#pendingInvites{margin:5px;padding:5px;background:#fff;border-radius:8px;}
#pendingInvites button{margin-left:5px;}
</style>
</head>
<body>

<header>
  <img id="groupPhoto" src="">
  <h2 id="groupName"></h2>
  <div id="members"></div>
</header>

<div id="pendingInvites"></div>
<div id="chatBox"></div>

<div id="inputArea">
  <div class="icon" onclick="toggleFilePopup()">+</div>
  <input type="text" id="msgInput" placeholder="Type a message...">
  <div class="controls">
    <button onclick="startAudioCall()">ðŸŽ¤</button>
    <button onclick="startVideoCall()">ðŸ“¹</button>
  </div>
  <button onclick="sendMessage()">âž¤</button>
</div>

<div id="filePopup">
  <button onclick="sendFile()">File</button>
  <button onclick="sendPhoto()">Photo</button>
  <button onclick="sendVideo()">Video</button>
  <button onclick="sendLocation()">Location</button>
</div>

<input type="file" id="photoInput" style="display:none" accept="image/*">

<script>
let groups = JSON.parse(localStorage.getItem("groups") || "[]");
let index = localStorage.getItem("currentGroupIndex");
let group = groups[index];

// Display group name/photo
const groupNameEl = document.getElementById("groupName");
const groupPhotoEl = document.getElementById("groupPhoto");
groupNameEl.innerText = group.name;
groupPhotoEl.src = group.photo || "group.png";

// Change group name/photo
groupPhotoEl.onclick = changePhoto;
groupNameEl.onclick = changeName;

function changePhoto(){
  const input = document.getElementById("photoInput");
  input.click();
  input.onchange = function(e){
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(ev){
      group.photo = ev.target.result;
      groupPhotoEl.src = group.photo;
      save();
    }
    reader.readAsDataURL(file);
  }
}

function changeName(){
  const newName = prompt("Enter new group name:", group.name);
  if(newName){
    group.name = newName;
    groupNameEl.innerText = group.name;
    save();
  }
}

// Members
function renderMembers(){
  const div = document.getElementById("members");
  div.innerHTML = "";
  group.members.filter(m=>m.accepted).forEach(m=>{
    div.innerHTML += `<div>${m.name}</div>`;
  });
}
renderMembers();

// Pending invites
function renderPending(){
  const div = document.getElementById("pendingInvites");
  div.innerHTML = "";
  group.pending.forEach((p,i)=>{
    div.innerHTML += `<span>${p}<button onclick="acceptInvite(${i})">âœ”</button><button onclick="rejectInvite(${i})">âœ–</button></span>`;
  });
}
renderPending();

function acceptInvite(i){
  const member = group.pending[i];
  group.members.push({name:member, accepted:true});
  group.pending.splice(i,1);
  save(); renderMembers(); renderPending();
}

function rejectInvite(i){
  group.pending.splice(i,1);
  save(); renderPending();
}

// Messages
const chatBox = document.getElementById("chatBox");
function renderMessages(){
  chatBox.innerHTML = "";
  group.messages.forEach(m=>{
    if(group.blocked.includes(m.sender)) return;
    const div = document.createElement("div");
    div.className="message"+(m.sender==="You"?" self":"");
    if(m.type==="photo") div.innerHTML=`<img src="${m.content}" style="max-width:100px"><strong>${m.sender}</strong>`;
    else if(m.type==="video") div.innerHTML=`<video src="${m.content}" controls style="max-width:150px"></video><strong>${m.sender}</strong>`;
    else div.innerHTML=`<strong>${m.sender}:</strong> ${m.text || ""}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}
renderMessages();

// Send text
function sendMessage(){
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if(!text) return;
  if(group.blocked.includes("You")){ alert("You are blocked!"); return; }
  group.messages.push({sender:"You", type:"text", text});
  input.value="";
  group.unread = true;
  save();
  renderMessages();
}

// File popup
function toggleFilePopup(){
  const popup = document.getElementById("filePopup");
  popup.style.display = popup.style.display==="none"?"block":"none";
}

function sendFile(){
  const content = prompt("Enter file description or URL");
  if(content) { group.messages.push({sender:"You", type:"file", content}); save(); renderMessages(); toggleFilePopup(); }
}
function sendPhoto(){
  const input = document.createElement("input");
  input.type="file"; input.accept="image/*";
  input.onchange = function(e){
    const file = e.target.files[0]; const reader = new FileReader();
    reader.onload = function(ev){
      group.messages.push({sender:"You", type:"photo", content:ev.target.result});
      save(); renderMessages();
    }
    reader.readAsDataURL(file);
  }
  input.click();
}
function sendVideo(){
  const input = document.createElement("input");
  input.type="file"; input.accept="video/*";
  input.onchange = function(e){
    const file = e.target.files[0]; const reader = new FileReader();
    reader.onload = function(ev){
      group.messages.push({sender:"You", type:"video", content:ev.target.result});
      save(); renderMessages();
    }
    reader.readAsDataURL(file);
  }
  input.click();
}
function sendLocation(){
  const loc = prompt("Enter location URL or text");
  if(loc){ group.messages.push({sender:"You", type:"location", text:loc}); save(); renderMessages(); }
}

// Calls placeholders
function startAudioCall(){ alert("Audio call placeholder"); }
function startVideoCall(){ alert("Video call placeholder"); }

// Save
function save(){
  groups[index] = group;
  localStorage.setItem("groups", JSON.stringify(groups));
}

group.unread = false;
save();
</script>
</body>
</html>
