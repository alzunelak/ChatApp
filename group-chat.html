<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GazaChat Group</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
body { margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#000;color:#fff;height:100vh;display:flex;flex-direction:column; }
#chatPage,#groupInfoPage{display:flex;flex-direction:column;flex:1;}
.header{display:flex;align-items:center;justify-content:space-between;background:#fff;color:white;padding:10px;}
.header img{width:50px;height:50px;border-radius:50%;cursor:pointer;object-fit:cover;}
.header-info{flex:1;display:flex;flex-direction:column;margin-left:10px;overflow:hidden;}
.header-info h2{margin:0;font-size:16px;cursor:pointer;}
.header-info #members{font-size:12px;color:#d0f0e3;}
#chatBox{flex:1;overflow-y:auto;padding:10px;margin-bottom:100px;}
.msg{max-width:70%;padding:10px 14px;margin:5px 0;border-radius:18px;background:#25d366;align-self:flex-start;position:relative;word-break:break-word;}
.msg.self{background:#dcf8c6;align-self:flex-end;}
.msg .meta{font-size:10px;color:#999;text-align:right;}
#inputArea{display:flex;align-items:center;position:fixed;bottom:10px;left:10px;width:calc(100%-20px);z-index:100;}
.input-box{display:flex;flex:1;background:#f1f1f1;border-radius:25px;padding:6px 10px;gap:6px;}
.input-box input{flex:1;border:none;outline:none;font-size:14px;background:transparent;}
.input-buttons button{background:transparent;border:none;font-size:20px;cursor:pointer;color:#128C7E;}
#micBtn{width:40px;height:40px;border-radius:50%;background:#25D366;color:white;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:6px;}
.groupHeader{display:flex;flex-direction:column;align-items:center;padding:15px;background:#fff;color:#000;margin-bottom:10px;border-radius:10px;position:relative;}
.groupHeader img{width:80px;height:80px;border-radius:50%;cursor:pointer;margin-bottom:10px;object-fit:cover;}
.groupHeader h2{margin:0;font-size:18px;font-weight:500;cursor:text;}
.backArrow{position:absolute;left:10px;top:20px;font-size:20px;cursor:pointer;color:#fff;}
.actionButtons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;width:100%;}
.actionButtons button{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 0;background:#000;border:1px solid #eee;border-radius:8px;cursor:pointer;}
.actionButtons i{font-size:20px;margin-bottom:5px;}
.container{background:#000;padding:10px;margin:10px;border-radius:10px;}
.settingsContainer{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #ccc;border-bottom:1px solid #ccc;background:#000;border-radius:8px;}
.settingsContainer button{width:100%;padding:12px 15px;border:none;background:#000;display:flex;align-items:center;justify-content:space-between;gap:10px;color:#fff;font-size:16px;cursor:pointer;border-radius:6px;transition:background 0.2s;}
.settingsContainer button:hover{background:#f1f1f1;}
.settingsContainer i{color:black;font-size:18px;}
.settingsContainer input[type="checkbox"]{transform:scale(1.2);cursor:pointer;}
#groupMembersList{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #ccc;border-bottom:1px solid #ccc;}
.memberBox{padding:5px 10px;background:#000;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.membersHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
#memberCount{font-weight:500;font-size:16px;}
#addMemberBtn{width:30px;height:30px;border-radius:50%;background:#25d366;color:white;font-size:20px;border:none;cursor:pointer;}
#groupLinks{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #ccc;border-bottom:1px solid #ccc;}
#groupLinks button{width:100%;padding:10px;border:none;border-radius:5px;background:#000;color:#fff;cursor:pointer;text-align:left;}
.actionBox{display:flex;flex-direction:column;gap:8px;padding:10px;border-top:1px solid #ccc;border-bottom:1px solid #ccc;}
.actionBox button{width:100%;padding:12px 15px;border:none;background:#fff;display:flex;align-items:center;gap:30px;color:red;font-size:16px;cursor:pointer;}
.actionBox i{color:red;font-size:18px;}
.popup {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:15px;border:1px solid #ccc;border-radius:8px;z-index:1000;width:300px;max-height:400px;overflow-y:auto;}
.popup h3{margin-top:0;}
.popup button.closeBtn{margin-top:10px;float:right;}
.popup div.item{padding:5px;cursor:pointer;border-bottom:1px solid #eee;}
.popup button.unblockBtn{background:#25D366;color:#fff;border:none;border-radius:5px;padding:2px 5px;cursor:pointer;}
.settingsItem {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  background: #fff;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
  box-sizing: border-box;
  font-size: 16px;
  border: none; /* no borders at all */
  min-height: 50px; /* uniform height */
}

/* Make Mesh Network text small but keep height same */
.settingsItem small {
  font-size: 14px;
  color: #555;
}

/* Keep Chat Lock switch aligned */
.settingsItem label.switch {
  margin: 0;
}

/* Make Mesh Network fully clickable with same height */
.settingsItem:last-child {
  cursor: default;
  justify-content: flex-start;
}


  /* Phones animation */
.phoneAnimation {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
  height: 100px;
  gap: 40px;
}

.phone {
  width: 50px;
  height: 90px;
  border: 2px solid #128C7E;
  border-radius: 10px;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e6f7f1;
  animation: bounce 1.5s infinite alternate;
}

.phone .screen {
  width: 90%;
  height: 80%;
  background: #fff;
  border-radius: 5px;
}

/* Bounce animation */
@keyframes bounce {
  0% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
  100% { transform: translateY(0); }
}

/* Check mark animation */
.checkMark {
  position: absolute;
  font-size: 30px;
  color: #25D366;
  opacity: 0;
  transform: scale(0);
  animation: appear 2s forwards 1.5s;
}

@keyframes appear {
  0% { opacity: 0; transform: scale(0); }
  50% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 1; transform: scale(1); }
}

/* Modal styling */
.encryptionContent {
  text-align: center;
}

  /* ==== MODAL STYLES ==== */
.modal {display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);z-index:4000;align-items:center;justify-content:center;}
.modal-content {background:#fff;padding:20px;border-radius:12px;width:300px;
  box-shadow:0 6px 18px rgba(0,0,0,0.3);}
.option-group {display:flex;flex-direction:column;gap:8px;margin:15px 0;}
.close-btn {background:#128C7E;color:#fff;border:none;padding:10px 15px;
  border-radius:8px;cursor:pointer;width:100%;font-size:16px;}

/* SWITCH STYLE */
.switch {position:relative;display:inline-block;width:50px;height:24px;}
.switch input {opacity:0;width:0;height:0;}
.slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
  background:#ccc;transition:.4s;border-radius:24px;}
.slider:before {position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;
  background:white;transition:.4s;border-radius:50%;}
input:checked + .slider {background:#128C7E;}
input:checked + .slider:before {transform:translateX(26px);}

    
  /* Popup menu for 3-dot options */
.popupMenu {
  display:none;
  position:absolute;
  right:10px;
  top:60px;
  background:#fff;
  border:1px solid #ccc;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  z-index:2000;
  width:160px;
}
.popupMenu .menuItem {
  padding:10px;
  cursor:pointer;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:10px;
}
.popupMenu .menuItem:hover {
  background:#f1f1f1;
}



@media (min-width: 1024px) {
    /* Make input box taller */
    #inputArea {
        bottom:20px;
    }

#inputArea {
  display:flex;
  align-items:center;
  position:fixed;
  bottom:10px;
  left:10px;
  width: calc(100% - 20px); /* fix syntax */
  z-index:1000;              /* ensure on top */
}

#chatBox {
  flex:1;
  overflow-y:auto;
  padding:10px;
  margin-bottom:120px; /* ensure enough space */
}

    
</style>
</head>
<body>

<!-- CHAT PAGE -->
<div id="chatPage">
  <div class="header">
    <img id="groupPhoto" src="profile.png">
    <div class="header-info">
      <h2 id="groupName">My Group</h2>
      <div id="members"></div>
    </div>
    <div class="header-actions">
      <button id="callBtn"><i class="fa-solid fa-phone"></i></button>
      <button id="menuBtn"><i class="fa-solid fa-ellipsis-vertical"></i></button>
    </div>
  </div>


  
<div id="menuPopup" class="popupMenu">
  <div class="menuItem" id="viewInfo"><i class="fa-solid fa-circle-info"></i> View Info</div>
  <div class="menuItem" id="muteChat"><i class="fa-solid fa-bell-slash"></i> Mute</div>
  <div class="menuItem" id="deleteChat"><i class="fa-solid fa-trash"></i> Delete Chat</div>
</div>

  
  <div id="chatBox"></div>
  <div id="inputArea">
    <div class="input-box">
      <input id="msgInput" placeholder="Type a message...">
      <div class="input-buttons">
        <button id="emojiBtn"><i class="fa-solid fa-face-smile"></i></button>
        <button id="plusBtn"><i class="fa-solid fa-paperclip"></i></button>
      </div>
    </div>
    <button id="micBtn"><i class="fa-solid fa-microphone"></i></button>
  </div>
</div>



<!-- ATTACHMENT MENU -->
<div id="attachmentMenu" class="popupMenu" style="top:auto; bottom:60px; right:10px; display:none; width:200px;">
  <div class="menuItem" id="attachGallery"><i class="fa-solid fa-image"></i> Gallery</div>
  <div class="menuItem" id="attachCamera"><i class="fa-solid fa-camera"></i> Camera</div>
  <div class="menuItem" id="attachDocument"><i class="fa-solid fa-file"></i> Document</div>
  <div class="menuItem" id="attachAudio"><i class="fa-solid fa-microphone"></i> Audio</div>
  <div class="menuItem" id="attachContact"><i class="fa-solid fa-address-book"></i> Contact</div>
  <div class="menuItem" id="attachLocation"><i class="fa-solid fa-location-dot"></i> Location</div>
</div>

  
<!-- GROUP INFO PAGE -->
<div id="groupInfoPage" style="display:none;">
  <div class="groupHeader">
    <i class="fa-solid fa-arrow-left backArrow" onclick="backToChat()"></i>
    <img id="infoGroupPhoto" src="profile.png">
    <h2 id="infoGroupName" contenteditable="true">My Group</h2>
    <div class="actionButtons">
      <button><i class="fa-solid fa-video"></i><span>Video Call</span></button>
      <button><i class="fa-solid fa-phone"></i><span>Audio Call</span></button>
      <button><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></button>
    </div>
  </div>
  <!-- SETTINGS FEATURES SECTION -->
<div class="settingsContainer" style="margin-top:20px; gap:10px; display:flex; flex-direction:column;">
<button class="settingsItem" onclick="openEncryptionPopup()">
  <span>End-to-End Encryption</span>
  <i class="fa-solid fa-circle-info"></i>
</button>

<!-- END-TO-END ENCRYPTION POPUP WITH ANIMATION -->
<div id="encryptionModal" class="modal">
  <div class="modal-content encryptionContent">
    <h2>End-to-End Encryption</h2>
    <p>Messages and calls in this group are secured with end-to-end encryption.</p>

    <div class="phoneAnimation">
      <div class="phone leftPhone">
        <div class="screen"></div>
      </div>
      <div class="phone rightPhone">
        <div class="screen"></div>
      </div>
      <div class="checkMark">&#10003;</div>
    </div>

    <p style="margin-top:20px;">
      Only participants in this chat can read or listen to them.
      No one outside this chat, not even the app, can access your messages.
    </p>

    <button class="close-btn" onclick="closeEncryptionPopup()">Close</button>
  </div>
</div>

  <div class="settingsItem" style="flex-direction:column; align-items:flex-start;">
    <span>Mesh Network</span>
    <small>Peer-to-peer sync and nearby chat sharing enabled automatically.</small>
  </div>
  
  <div class="settingsItem">
    <span>Chat Lock</span>
    <label class="switch">
      <input type="checkbox" id="chatLockToggle">
      <span class="slider"></span>
    </label>
  </div>
  
<!-- Disappearing Messages button with status text -->
<div class="settingsItem" style="flex-direction:column; align-items:flex-start; cursor:pointer;">
  <button id="disappearBtn" style="width:100%; display:flex; justify-content:space-between; border:none; background:none; padding:0;">
    <span>Disappearing Messages</span>
    <i class="fa-solid fa-clock"></i>
  </button>
  <small id="disappearStatus" style="color:#555; margin-top:4px;">Off</small>
</div>

<!-- POPUP MODAL -->
<div id="disappearModal" class="modal">
  <div class="modal-content">
    <h2>Disappearing Messages</h2>
    <div class="option-group">
      <label><input type="radio" name="disappear" value="off" checked> Off</label>
      <label><input type="radio" name="disappear" value="24h"> 24 Hours</label>
      <label><input type="radio" name="disappear" value="7d"> 7 Days</label>
      <label><input type="radio" name="disappear" value="90d"> 90 Days</label>
    </div>
    <button class="close-btn" onclick="closeDisappearModal()">Done</button>
  </div>
</div>
</div>
 

  <div class="container">
    <div class="membersHeader">
      <span id="memberCount">0 Members</span>
      <button id="addMemberBtn">+</button>
    </div>
    <div id="groupMembersList"></div>
  </div>

  <div class="container" id="groupLinks">
    <button id="showGroupLink">Group Link</button>
    <button id="showBlockedUsers">Blocked Users</button>
    <button id="showRequestInvite">Request / Invite</button>
  </div>

  <div class="container actionBox">
    <button><i class="fa-solid fa-sign-out"></i> Leave Group</button>
    <button><i class="fa-solid fa-ban"></i> Block Group</button>
    <button><i class="fa-solid fa-flag"></i> Report Group</button>
    <button><i class="fa-solid fa-trash"></i> Delete Group</button>
  </div>

  <input type="file" id="groupPhotoFile" accept="image/*" style="display:none;">
</div>

<!-- POPUPS -->
<div id="linkPopup" class="popup">
  <h3>Invite Link</h3>
  <input type="text" id="groupLinkInput" readonly style="width:100%; padding:5px;">
  <button onclick="copyLink()">Copy</button>
  <button class="closeBtn" onclick="closePopup()">Close</button>
</div>

<div id="blockedPopup" class="popup">
  <h3>Blocked Users</h3>
  <div id="blockedList"></div>
  <button class="closeBtn" onclick="closeBlockedPopup()">Close</button>
</div>

<script>
// ===== STATE =====
let myName = "You"; // current user
let groups = JSON.parse(localStorage.getItem("groups") || "[]");
let currentGroupIndex = parseInt(localStorage.getItem("currentGroupIndex") || "-1");
let currentGroup = groups[currentGroupIndex];

if(!currentGroup){
  alert("No group selected. Redirecting...");
  window.location.href = "groups.html";
}

let currentUser = myName;
let isAdmin = (currentGroup.admin === myName);
let currentGroupMembers = currentGroup.members.map(m=>m.name);
let blockedMembers = currentGroup.blocked || [];
let messages = currentGroup.messages || [];

const callContainer = document.getElementById("callContainer");

// ===== VIDEO CALL =====
document.querySelector(".actionButtons button:nth-child(1)").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

    // Create video container
    const container = document.createElement("div");
    container.style.position = "relative";
    container.style.border = "2px solid #128C7E";
    container.style.borderRadius = "10px";
    container.style.marginTop = "10px";
    container.style.width = "100%";
    container.style.maxHeight = "400px";
    container.style.background = "#000";

    // Video element
    const videoEl = document.createElement("video");
    videoEl.srcObject = stream;
    videoEl.autoplay = true;
    videoEl.style.width = "100%";
    videoEl.style.height = "300px";
    container.appendChild(videoEl);

    // Close button
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "End Call";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "5px";
    closeBtn.style.right = "5px";
    closeBtn.style.padding = "5px 10px";
    closeBtn.style.background = "#25D366";
    closeBtn.style.color = "#fff";
    closeBtn.style.border = "none";
    closeBtn.style.borderRadius = "5px";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = () => {
      stream.getTracks().forEach(track => track.stop());
      container.remove();
    };
    container.appendChild(closeBtn);

    document.getElementById("groupInfoPage").appendChild(container);

  } catch (err) {
    alert("Cannot access camera/microphone. Check permissions.");
    console.error(err);
  }
};

// ===== AUDIO CALL =====
document.querySelector(".actionButtons button:nth-child(2)").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Create audio container
    const container = document.createElement("div");
    container.style.position = "relative";
    container.style.border = "2px solid #128C7E";
    container.style.borderRadius = "10px";
    container.style.marginTop = "10px";
    container.style.padding = "10px";
    container.style.background = "#f1f1f1";

    // Audio element
    const audioEl = document.createElement("audio");
    audioEl.srcObject = stream;
    audioEl.autoplay = true;
    container.appendChild(audioEl);

    // Close button
    const closeBtn = document.createElement("button");
    closeBtn.textContent = "End Call";
    closeBtn.style.position = "absolute";
    closeBtn.style.top = "5px";
    closeBtn.style.right = "5px";
    closeBtn.style.padding = "5px 10px";
    closeBtn.style.background = "#25D366";
    closeBtn.style.color = "#fff";
    closeBtn.style.border = "none";
    closeBtn.style.borderRadius = "5px";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = () => {
      stream.getTracks().forEach(track => track.stop());
      container.remove();
    };
    container.appendChild(closeBtn);

    document.getElementById("groupInfoPage").appendChild(container);

  } catch (err) {
    alert("Cannot access microphone. Check permissions.");
    console.error(err);
  }
};

// ===== SEARCH MESSAGES =====
document.querySelector(".actionButtons button:nth-child(3)").onclick = () => {
  const keyword = prompt("Enter keyword to search in messages:");
  if (!keyword) return;

  chatBox.innerHTML = "";
  messages.forEach(m => {
    if (blockedMembers.includes(m.user)) return;
    if (m.text.toLowerCase().includes(keyword.toLowerCase())) {
      const div = document.createElement("div");
      div.className = "msg" + (m.user === currentUser ? " self" : "");
      div.innerHTML = `<div class="content"><b>${m.user}:</b> ${m.text}</div><div class="meta">${m.time}</div>`;
      chatBox.appendChild(div);
    }
  });

  // Add reset button
  if (!document.getElementById("resetSearchBtn")) {
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Reset Search";
    resetBtn.id = "resetSearchBtn";
    resetBtn.style.margin = "10px";
    resetBtn.style.padding = "5px 10px";
    resetBtn.style.background = "#128C7E";
    resetBtn.style.color = "#fff";
    resetBtn.style.border = "none";
    resetBtn.style.borderRadius = "5px";
    resetBtn.style.cursor = "pointer";
    resetBtn.onclick = () => {
      renderMessages();
      resetBtn.remove();
    };
    chatBox.parentElement.insertBefore(resetBtn, chatBox);
  }
};

    

// ===== MENU BUTTON TOGGLE =====
const menuBtn = document.getElementById("menuBtn");
const menuPopup = document.getElementById("menuPopup");

menuBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  menuPopup.style.display = (menuPopup.style.display==="block") ? "none" : "block";
});

// Close menu when clicking outside
document.addEventListener("click", ()=> menuPopup.style.display="none");

// ===== MENU ITEM ACTIONS =====
document.getElementById("viewInfo").onclick = ()=>{
  openGroupInfo();
  menuPopup.style.display="none";
};

document.getElementById("muteChat").onclick = ()=>{
  alert("Chat muted.");
  menuPopup.style.display="none";
};

document.getElementById("deleteChat").onclick = ()=>{
  if(confirm("Delete all messages?")){
    messages = [];
    currentGroup.messages = [];
    groups[currentGroupIndex] = currentGroup;
    localStorage.setItem("groups", JSON.stringify(groups));
    renderMessages();
  }
  menuPopup.style.display="none";
};




const plusBtn = document.getElementById("plusBtn");
const attachmentMenu = document.getElementById("attachmentMenu");

// Toggle attachment menu
plusBtn.addEventListener("click", e=>{
  e.stopPropagation();
  attachmentMenu.style.display = (attachmentMenu.style.display==="block") ? "none" : "block";
});
document.addEventListener("click", ()=> attachmentMenu.style.display="none");

// Trigger file/location inputs
document.getElementById("attachGallery").onclick = () => { document.getElementById("galleryInput").click(); };
document.getElementById("attachCamera").onclick = () => { document.getElementById("cameraInput").click(); };
document.getElementById("attachDocument").onclick = () => { document.getElementById("documentInput").click(); };
document.getElementById("attachAudio").onclick = () => { document.getElementById("audioInput").click(); };
document.getElementById("attachContact").onclick = () => { document.getElementById("contactInput").click(); };
document.getElementById("attachLocation").onclick = () => { document.getElementById("locationInput").click(); };



 // ===== AUDIO RECORDING =====
let mediaRecorder;
let audioChunks = [];
const micBtn = document.getElementById("micBtn");

micBtn.addEventListener("mousedown", startRecording);   // PC press
micBtn.addEventListener("touchstart", startRecording);  // Mobile press
micBtn.addEventListener("mouseup", stopRecording);      // PC release
micBtn.addEventListener("touchend", stopRecording);     // Mobile release

function startRecording() {
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.start();
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };
    })
    .catch(err => {
      console.error("Mic error:", err);
      alert("Cannot access microphone. Check permissions or use HTTPS/localhost.");
    });
}


function stopRecording() {
  if (!mediaRecorder) return;

  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
    const audioUrl = URL.createObjectURL(audioBlob);

    // create message with audio
    const newMsg = {
      id: uid(),
      text: "",
      audio: audioUrl,   // <-- store audio
      self: true,
      user: currentUser,
      time: new Date().toLocaleString()
    };
    messages.push(newMsg);

    // Save
    currentGroup.messages = messages;
    groups[currentGroupIndex] = currentGroup;
    localStorage.setItem("groups", JSON.stringify(groups));

    renderMessages();
  };
}
function renderMessages() {
  chatBox.innerHTML = "";
  messages.forEach(m => {
    if (blockedMembers.includes(m.user)) return;
    const div = document.createElement("div");
    div.className = "msg" + (m.user === currentUser ? " self" : "");

    if (m.audio) {
      div.innerHTML = `
        <div class="content"><b>${m.user}:</b> 
          <audio controls src="${m.audio}"></audio>
        </div>
        <div class="meta">${m.time}</div>`;
    } else {
      div.innerHTML = `
        <div class="content"><b>${m.user}:</b> ${m.text}</div>
        <div class="meta">${m.time}</div>`;
    }
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}


  
  
// ===== CHAT =====
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("msgInput");

function uid(){ return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8); }

msgInput.addEventListener("keydown", e => {
  if(e.key==="Enter"){
    e.preventDefault();
    const txt=msgInput.value.trim();
    if(!txt) return;
    const newMsg = {id:uid(), text:txt, self:true, user:currentUser, time:new Date().toLocaleString()};
    messages.push(newMsg);
    msgInput.value="";
    renderMessages();

    // Save message to group
    currentGroup.messages = messages;
    groups[currentGroupIndex] = currentGroup;
    localStorage.setItem("groups", JSON.stringify(groups));
  }
});

function renderMessages(){
  chatBox.innerHTML="";
  messages.forEach(m=>{
    if(blockedMembers.includes(m.user)) return;
    const div=document.createElement("div");
    div.className="msg"+(m.user===currentUser?" self":"");
    div.innerHTML=`<div class="content"><b>${m.user}:</b> ${m.text}</div><div class="meta">${m.time}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ===== GROUP MEMBERS =====
function renderGroupMembers(){
  const membersDiv=document.getElementById("groupMembersList");
  membersDiv.innerHTML="";
  const activeMembers=currentGroupMembers.filter(m=>!blockedMembers.includes(m));
  if(activeMembers.length===0){
    const div=document.createElement("div");
    div.textContent="No active members"; div.style.fontStyle="italic"; div.style.color="#555";
    membersDiv.appendChild(div);
  } else {
    activeMembers.forEach(name=>{
      const div=document.createElement("div");
      div.className="memberBox"; div.textContent=name;
      if(isAdmin && name!==currentUser){
        const btn=document.createElement("button");
        btn.textContent="Block"; btn.style.marginLeft="10px";
        btn.onclick=()=>blockMember(name);
        div.appendChild(btn);
      }
      membersDiv.appendChild(div);
    });
  }
  document.getElementById("memberCount").textContent=`${activeMembers.length} Member${activeMembers.length!==1?"s":""}`;

  // Update in groups array
  currentGroup.members = currentGroupMembers.map(n=>({name:n, accepted:true}));
  currentGroup.blocked = blockedMembers;
  groups[currentGroupIndex] = currentGroup;
  localStorage.setItem("groups", JSON.stringify(groups));

  // Update chat header members
  document.getElementById("members").textContent = activeMembers.join(", ");
}

// ===== ADD MEMBER =====
document.getElementById("addMemberBtn").onclick = ()=>{
  localStorage.setItem("currentGroupMembers", JSON.stringify(currentGroupMembers));
  window.location.href = "addMembers.html";
};
function addMember(name){
    if(!currentGroupMembers.includes(name)){
        currentGroupMembers.push(name);
        currentGroup.members.push({name:name, accepted:true});
        groups[currentGroupIndex] = currentGroup;
        localStorage.setItem('groups', JSON.stringify(groups));
        renderGroupMembers();
    }
}

  
// ===== NAVIGATION =====
document.getElementById("groupName").onclick = ()=>openGroupInfo();
function openGroupInfo(){
  document.getElementById("chatPage").style.display="none";
  document.getElementById("groupInfoPage").style.display="block";
  renderGroupMembers();
}
function backToChat(){
  document.getElementById("groupInfoPage").style.display="none";
  document.getElementById("chatPage").style.display="flex";
}

// ===== GROUP PHOTO =====
document.getElementById("infoGroupPhoto").onclick=()=>{ document.getElementById("groupPhotoFile").click(); };
document.getElementById("groupPhotoFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=()=>{
      const url=reader.result;
      document.getElementById("infoGroupPhoto").src=url;
      document.getElementById("groupPhoto").src=url;
      currentGroup.photo = url;
      groups[currentGroupIndex] = currentGroup;
      localStorage.setItem("groups", JSON.stringify(groups));
    };
    reader.readAsDataURL(file);
  }
});

// ===== BLOCK MEMBER =====
function blockMember(name){
  if(confirm(`Block ${name}?`)){
    blockedMembers.push(name);
    renderGroupMembers();
  }
}

// ===== BLOCKED USERS POPUP =====
document.getElementById("showBlockedUsers").onclick = ()=>{
  renderBlockedUsersPopup();
  document.getElementById("blockedPopup").style.display="block";
};
function renderBlockedUsersPopup(){
  const listDiv=document.getElementById("blockedList");
  listDiv.innerHTML="";
  if(blockedMembers.length===0){
    listDiv.innerHTML="<p style='color:#555;font-style:italic;'>No blocked users</p>";
  } else {
    blockedMembers.forEach((u,index)=>{
      const div=document.createElement("div");
      div.className="item"; div.style.display="flex"; div.style.justifyContent="space-between"; div.style.alignItems="center";
      const nameSpan=document.createElement("span"); nameSpan.textContent=u;
      const unblockBtn=document.createElement("button"); unblockBtn.textContent="Unblock";
      unblockBtn.className="unblockBtn";
      unblockBtn.onclick=()=>{
        blockedMembers.splice(index,1);
        renderBlockedUsersPopup();
        renderGroupMembers();
      };
      div.appendChild(nameSpan); div.appendChild(unblockBtn); listDiv.appendChild(div);
    });
  }
}
function closeBlockedPopup(){ document.getElementById("blockedPopup").style.display="none"; }

// ===== GROUP LINK =====
document.getElementById("showGroupLink").onclick = ()=>{
  const inviteLink = `${window.location.origin}/join.html?group=${currentGroupIndex}`;
  document.getElementById("groupLinkInput").value = inviteLink;
  document.getElementById("linkPopup").style.display="block";
};
function copyLink(){
  const input = document.getElementById("groupLinkInput");
  input.select(); input.setSelectionRange(0,99999);
  navigator.clipboard.writeText(input.value);
  alert("Group link copied!");
}
function closePopup(){ document.getElementById("linkPopup").style.display="none"; }

// ===== REQUEST/INVITE =====
document.getElementById("showRequestInvite").onclick = () => {
    window.location.href = "requestInvite.html";
};

// ===== ACTION BOX BUTTONS =====
const leaveBtn = document.querySelector(".actionBox button:nth-child(1)");
const blockGroupBtn = document.querySelector(".actionBox button:nth-child(2)");
const reportGroupBtn = document.querySelector(".actionBox button:nth-child(3)");
const deleteGroupBtn = document.querySelector(".actionBox button:nth-child(4)");

leaveBtn.onclick = () => {
  if(confirm("Are you sure you want to leave the group?")){
    currentGroupMembers = currentGroupMembers.filter(n=>n!==myName);
    renderGroupMembers();
    currentGroup.members = currentGroupMembers.map(n=>({name:n,accepted:true}));
    groups[currentGroupIndex] = currentGroup;
    localStorage.setItem("groups", JSON.stringify(groups));
    window.location.href = "groups.html";
  }
};

blockGroupBtn.onclick = () => {
  if(confirm("Are you sure you want to block this group?")){
    alert("Group blocked.");
    window.location.href = "groups.html";
  }
};

reportGroupBtn.onclick = () => {
  if(confirm("Are you sure you want to report this group?")){
    alert("Group reported.");
    window.location.href = "groups.html";
  }
};

deleteGroupBtn.onclick = () => {
  if(!isAdmin){
    alert("Only admin can delete the group!");
    return;
  }
  if(confirm("Are you sure you want to DELETE the group? This cannot be undone.")){
    groups.splice(currentGroupIndex,1);
    localStorage.setItem("groups", JSON.stringify(groups));
    window.location.href = "groups.html";
  }
};

// ===== INITIAL RENDER =====
document.getElementById("groupName").textContent = currentGroup.name;
document.getElementById("infoGroupName").textContent = currentGroup.name;
document.getElementById("groupPhoto").src = currentGroup.photo || "group.png";
document.getElementById("infoGroupPhoto").src = currentGroup.photo || "group.png";

renderMessages();
renderGroupMembers();

// ===== EDIT GROUP NAME =====
document.getElementById("infoGroupName").addEventListener("blur",()=>{
  const newName=document.getElementById("infoGroupName").textContent.trim();
  if(newName){
    currentGroup.name=newName;
    groups[currentGroupIndex]=currentGroup;
    localStorage.setItem("groups",JSON.stringify(groups));
    document.getElementById("groupName").textContent=newName;
  }
});

    // ==== desappear ====
const disappearModal = document.getElementById("disappearModal");
const disappearBtn = document.getElementById("disappearBtn");
const disappearStatus = document.getElementById("disappearStatus");

// Open modal
disappearBtn.onclick = () => {
  disappearModal.style.display = "flex";
}

// Close modal
function closeDisappearModal(){
  disappearModal.style.display = "none";
  // Update status text based on selected radio
  const selected = document.querySelector('input[name="disappear"]:checked').nextSibling.textContent.trim();
  disappearStatus.textContent = selected;
}

// ==== end to end ====
  function openEncryptionPopup() {
    document.getElementById("encryptionModal").style.display = "flex";
}

function closeEncryptionPopup() {
    document.getElementById("encryptionModal").style.display = "none";

    // reset check mark animation
    const check = document.querySelector(".checkMark");
    check.style.opacity = 0;
    check.style.transform = "scale(0)";
    void check.offsetWidth; // force reflow for replay
    check.style.animation = "appear 2s forwards 1.5s";
}

</script>
</body>
</html>
