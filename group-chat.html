<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Chat</title>
<style>
body{font-family:Arial;margin:0;background:#e5ddd5;}
.header{background:#25d366;color:white;text-align:center;padding:10px;position:relative;}
.header img{width:80px;height:80px;border-radius:50%;margin-top:5px;cursor:pointer;}
.header h2{margin:5px 0;cursor:pointer;}
#members{display:flex;flex-wrap:wrap;justify-content:center;margin:5px;}
#members div{background:#128C7E;color:white;padding:5px 10px;border-radius:15px;margin:2px;position:relative;}
#members div span{cursor:pointer;margin-left:5px;}
#chatBox{height:300px;overflow-y:auto;padding:10px;background:#ece5dd;margin:10px;border-radius:8px;display:flex;flex-direction:column;}
.msg{background:white;padding:8px 12px;margin:5px 0;border-radius:8px;display:flex;align-items:center;}
.msg.self{background:#dcf8c6;align-self:flex-end;}
.msg img{width:30px;height:30px;border-radius:50%;margin-right:5px;}
#inputArea{display:flex;padding:10px;background:white;border-radius:25px;margin:10px;align-items:center;position:relative;}
#inputArea input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;}
#inputArea button{margin-left:5px;padding:10px 12px;border:none;border-radius:50%;background:#25d366;color:white;cursor:pointer;}
#topMenu{display:none;position:absolute;top:45px;right:10px;background:white;padding:10px;border-radius:8px;box-shadow:0 0 5px #888;flex-direction:column;min-width:120px;}
#topMenu button{margin:3px 0;padding:8px;border:none;border-radius:6px;background:#128C7E;color:white;cursor:pointer;text-align:left;}
#topMenu button:hover{background:#0d6b61;}
</style>
</head>
<body>

<div class="header">
  <h2 id="groupName"></h2>
  <img id="groupPhoto" src="">
  <div id="members"></div>
  <button id="topPlus">+</button>
  <div id="topMenu">
    <button id="addFriendBtn">‚ûï Add Friend</button>
    <button id="inviteBtn">üì© Invite</button>
    <button id="leaveBtn">üö™ Leave Group</button>
    <button id="deleteBtn">üóëÔ∏è Delete Group</button>
  </div>
</div>

<div id="chatBox"></div>

<div id="inputArea">
  <input id="msgInput" placeholder="Type a message...">
  <button id="sendBtn">‚û§</button>
</div>

<script>
// Setup
let groups = JSON.parse(localStorage.getItem("groups")||"[]");
let currentIndex = localStorage.getItem("currentGroupIndex")||0;
let group = groups[currentIndex] || {name:"New Group",photo:"",members:[],messages:[],blocked:[],invited:[],admin:"You"};
const myName = "You";

// Header
document.getElementById("groupName").innerText = group.name;
document.getElementById("groupPhoto").src = group.photo;

// Change name/photo
document.getElementById("groupName").onclick = ()=>{
  const newName = prompt("Enter new group name:", group.name);
  if(newName){ group.name=newName; saveGroup(); document.getElementById("groupName").innerText=newName; }
};
document.getElementById("groupPhoto").onclick = ()=>{
  const input = document.createElement("input"); input.type="file"; input.accept="image/*";
  input.onchange = e=>{
    const file=e.target.files[0];
    if(file){ const reader=new FileReader(); reader.onload=()=>{ group.photo=reader.result; saveGroup(); document.getElementById("groupPhoto").src=group.photo; }; reader.readAsDataURL(file);}
  }; input.click();
};

// Members
function renderMembers(){
  const div=document.getElementById("members"); div.innerHTML="";
  group.members.filter(m=>m.accepted).forEach(m=>{
    const mDiv=document.createElement("div"); mDiv.textContent=m.name;
    if(group.admin===myName && m.name!==myName){
      const blockSpan=document.createElement("span");
      blockSpan.textContent = group.blocked.includes(m.name)?"üö´":"‚≠ï";
      blockSpan.onclick=()=>{ toggleBlock(m.name); };
      mDiv.appendChild(blockSpan);
    }
    div.appendChild(mDiv);
  });
}
function toggleBlock(name){
  if(group.blocked.includes(name)) group.blocked=group.blocked.filter(x=>x!==name);
  else group.blocked.push(name);
  saveGroup(); renderMembers(); renderMessages(); checkBlockedStatus();
}

// Messages
const chatBox = document.getElementById("chatBox");
function renderMessages(){
  chatBox.innerHTML="";
  group.messages.forEach(m=>{
    if(group.blocked.includes(m.sender)) return;
    const div = document.createElement("div"); div.className="msg"+(m.sender===myName?" self":"");
    div.innerHTML=`<img src="profile.png"><strong>${m.sender}:</strong> ${m.text}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}
document.getElementById("sendBtn").onclick = ()=>{
  const txt = document.getElementById("msgInput").value.trim();
  if(!txt || group.blocked.includes(myName)) return;
  group.messages.push({sender:myName,text:txt});
  document.getElementById("msgInput").value=""; saveGroup(); renderMessages();
}
function checkBlockedStatus(){
  const input=document.getElementById("msgInput");
  const sendBtn=document.getElementById("sendBtn");
  if(group.blocked.includes(myName)){
    input.disabled=true; input.placeholder="‚ùå You are blocked";
    sendBtn.disabled=true; sendBtn.style.opacity="0.5"; sendBtn.style.cursor="not-allowed";
  } else {
    input.disabled=false; input.placeholder="Type a message...";
    sendBtn.disabled=false; sendBtn.style.opacity="1"; sendBtn.style.cursor="pointer";
  }
}

// Top menu
const topPlus=document.getElementById("topPlus");
const topMenu=document.getElementById("topMenu");
topPlus.onclick=()=>{ topMenu.style.display = topMenu.style.display==='flex'?'none':'flex'; }

// Add friend
document.getElementById("addFriendBtn").onclick = ()=>{
  topMenu.style.display='none';
  const name = prompt("Friend name to add:");
  if(!name) return;
  group.members.push({name,accepted:true});
  saveGroup(); renderMembers(); alert(name+" added!");
}

// Invite
document.getElementById("inviteBtn").onclick = ()=>{
  topMenu.style.display='none';
  const name = prompt("Friend name to invite:");
  if(!name) return;
  if(!group.invited.includes(name)) group.invited.push(name);
  saveGroup();
  const link = `${window.location.origin}/join.html?group=${encodeURIComponent(group.name)}&user=${encodeURIComponent(name)}`;
  alert(`Send this link to ${name}:\n${link}`);
}

// Leave group
document.getElementById("leaveBtn").onclick = ()=>{
  topMenu.style.display='none';
  if(confirm("Are you sure to leave?")){
    group.members=group.members.filter(m=>m.name!==myName);
    group.invited=group.invited.filter(x=>x!==myName);
    saveGroup(); alert("You left. Need new invite to rejoin."); window.location.href="groups.html";
  }
}

// Delete group (admin only)
const deleteBtn = document.getElementById("deleteBtn");
if(group.admin!==myName) deleteBtn.style.display='none';
deleteBtn.onclick = ()=>{
  topMenu.style.display='none';
  if(confirm("Are you sure to delete group?")){
    groups.splice(currentIndex,1); localStorage.setItem("groups",JSON.stringify(groups));
    alert("Group deleted"); window.location.href="groups.html";
  }
}

// Save
function saveGroup(){ groups[currentIndex]=group; localStorage.setItem("groups",JSON.stringify(groups)); }

renderMembers(); renderMessages(); checkBlockedStatus();
</script>
</body>
</html>
