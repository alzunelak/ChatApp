<!-- Same <head> and CSS as before, no changes needed -->
<body>

<div class="header">
  <h2 id="groupName"></h2>
  <img id="groupPhoto" src="">
  <div id="members"></div>
  <div id="topAdd">+</div>
  <div id="topMenu">
    <button id="addFriendBtn">➕ Add Friend</button>
    <button id="inviteBtn">📩 Invite</button>
    <button id="leaveBtn">🚪 Leave Group</button>
    <button id="deleteBtn" style="display:none;">🗑️ Delete Group</button>
  </div>
</div>

<div id="friendPopup"></div>
<div id="chatBox"></div>

<div id="inputArea">
  <input id="msgInput" placeholder="Type a message...">
  <button id="sendBtn">➤</button>
  <button id="plusBtn">+</button>

  <!-- Attachment Menu -->
  <div id="attachmentMenu">
    <div>
      <button id="sendFileBtn">📎 File</button>
      <button id="takePhotoBtn">🖼️ Photo</button>
      <button id="takeVideoBtn">🎥 Video</button>
      <button id="sendLocationBtn">📍 Location</button>
      <button id="audioCallBtn">📞 Audio Call</button>
      <button id="videoCallBtn">🎥 Video Call</button>
    </div>
  </div>
</div>

<script>
let groups = JSON.parse(localStorage.getItem("groups")||"[]");
let currentIndex = localStorage.getItem("currentGroupIndex")||0;
let group = groups[currentIndex]||{name:"My Group",photo:"profile.png",members:[],messages:[],admin:"You",invited:[],blocked:[]};
const myName="You";

// Render group info
const groupNameEl = document.getElementById("groupName");
const groupPhotoEl = document.getElementById("groupPhoto");
groupNameEl.innerText = group.name;
groupPhotoEl.src = group.photo || "profile.png";
if(group.admin===myName) document.getElementById("deleteBtn").style.display="block";

// --- Edit group name/photo ---
groupNameEl.onclick = ()=>{
  const newName = prompt("Enter new group name:", group.name);
  if(newName && newName.trim() !== ""){
    group.name = newName.trim();
    saveGroup();
    groupNameEl.innerText = group.name;
  }
};
groupPhotoEl.onclick = ()=>{
  const fileInput = document.createElement("input");
  fileInput.type = "file"; fileInput.accept="image/*";
  fileInput.onchange = e=>{
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = event=>{
        group.photo = event.target.result;
        saveGroup();
        groupPhotoEl.src = group.photo;
      }
      reader.readAsDataURL(file);
    }
  }
  fileInput.click();
};

// --- Members ---
function renderMembers(){
  const div=document.getElementById("members"); div.innerHTML="";
  group.members.filter(m=>m.accepted).forEach(m=>{
    const mDiv=document.createElement("div"); mDiv.textContent=m.name;
    if(group.admin===myName && m.name!==myName){
      const span=document.createElement("span"); 
      span.textContent = group.blocked.includes(m.name) ? "🚫" : "⭕";
      span.onclick=()=>{
        if(group.blocked.includes(m.name)) group.blocked=group.blocked.filter(x=>x!==m.name);
        else group.blocked.push(m.name);
        saveGroup(); renderMembers(); renderMessages(); checkBlockedStatus();
      }
      mDiv.appendChild(span);
    }
    div.appendChild(mDiv);
  });
}

// --- Chat messages ---
const chatBox = document.getElementById("chatBox");
function renderMessages(){
  chatBox.innerHTML="";
  group.messages.forEach((m,index)=>{
    if(group.blocked.includes(m.sender)) return;
    const div = document.createElement("div");
    div.className = "msg" + (m.sender===myName ? " self" : "");
    div.dataset.index = index;
    div.innerHTML = `<img src="profile.png"><strong>${m.sender}:</strong> ${m.text||"<i>This message was deleted</i>"}`;

    // Message options
    const options = document.createElement("div");
    options.className = "msgOptions";
    const btnDeleteMe = document.createElement("button"); btnDeleteMe.textContent="Delete for me";
    const btnDeleteAll = document.createElement("button"); btnDeleteAll.textContent="Delete for everyone";

    btnDeleteMe.onclick = e=>{
      e.stopPropagation();
      group.messages.splice(index,1);
      saveGroup();
      renderMessages();
    }
    btnDeleteAll.onclick = e=>{
      e.stopPropagation();
      group.messages[index].text="<i>This message was deleted</i>";
      saveGroup();
      renderMessages();
    }

    options.appendChild(btnDeleteMe);
    options.appendChild(btnDeleteAll);
    div.appendChild(options);

    div.onclick = e=>{
      e.stopPropagation();
      const visible = options.style.display==='flex';
      document.querySelectorAll('.msgOptions').forEach(mo=>mo.style.display='none');
      options.style.display = visible ? 'none' : 'flex';
    }

    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// --- Send message ---
document.getElementById("sendBtn").onclick = ()=>{
  const txt = document.getElementById("msgInput").value.trim();
  if(!txt || group.blocked.includes(myName)) return;
  group.messages.push({sender:myName,text:txt});
  document.getElementById("msgInput").value="";
  saveGroup();
  renderMessages();
}

// --- Friend leaving system message ---
document.getElementById("leaveBtn").onclick = ()=>{
  if(confirm("Leave group?")){
    group.members=group.members.filter(m=>m.name!==myName);
    group.messages.push({sender:"System", text:`${myName} left the group`});
    saveGroup();
    alert("You left the group."); 
    groups=groups.filter(g=>g.members.some(m=>m.name===myName));
    localStorage.setItem("groups",JSON.stringify(groups)); 
    window.location.href="groups.html";
  }
}

// --- Top menu + toggle ---
const topAdd = document.getElementById("topAdd");
const topMenu = document.getElementById("topMenu");
topAdd.onclick = e=>{
  e.stopPropagation();
  topMenu.style.display = (topMenu.style.display==='flex')?'none':'flex';
}

// --- Bottom + attachment menu ---
const plusBtn = document.getElementById("plusBtn");
const attachmentMenu = document.getElementById("attachmentMenu");
plusBtn.onclick = e=>{
  e.stopPropagation();
  attachmentMenu.style.display = (attachmentMenu.style.display==='flex')?'none':'flex';
}

// --- Click outside closes menus ---
document.addEventListener("click",(e)=>{
  if(!topMenu.contains(e.target) && e.target.id!=="topAdd") topMenu.style.display="none";
  if(!attachmentMenu.contains(e.target) && e.target.id!=="plusBtn") attachmentMenu.style.display="none";
  if(!document.getElementById("friendPopup").contains(e.target) && e.target.id!=="addFriendBtn") document.getElementById("friendPopup").style.display="none";
});

// --- Blocked check ---
function checkBlockedStatus(){
  const input = document.getElementById("msgInput");
  const btn = document.getElementById("sendBtn");
  if(group.blocked.includes(myName)){
    input.disabled = true;
    input.placeholder="❌ You are blocked";
    btn.disabled=true;
    btn.style.opacity="0.5";
    btn.style.cursor="not-allowed";
  } else {
    input.disabled = false;
    input.placeholder="Type a message...";
    btn.disabled=false;
    btn.style.opacity="1";
    btn.style.cursor="pointer";
  }
}

// --- Save group ---
function saveGroup(){ groups[currentIndex]=group; localStorage.setItem("groups",JSON.stringify(groups)); }

// Initial render
renderMembers();
renderMessages();
checkBlockedStatus();
</script>

</body>
</html>
