<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Chat</title>
<style>
body{font-family:Arial;margin:0;background:#e5ddd5;}
.header{background:#25d366;color:white;text-align:center;padding:10px;position:relative;}
.header img{width:80px;height:80px;border-radius:50%;margin-top:5px;cursor:pointer;}
.header h2{margin:5px 0;cursor:pointer;}
#members{display:flex;flex-wrap:wrap;justify-content:center;margin:5px;}
#members div{background:#128C7E;color:white;padding:5px 10px;border-radius:15px;margin:2px;position:relative;}
#members div span{cursor:pointer;margin-left:5px;}
#chatBox{height:300px;overflow-y:auto;padding:10px;background:#ece5dd;margin:10px;border-radius:8px;display:flex;flex-direction:column;}
.msg{background:white;padding:8px 12px;margin:5px 0;border-radius:8px;display:flex;align-items:center;}
.msg.self{background:#dcf8c6;align-self:flex-end;}
.msg img{width:30px;height:30px;border-radius:50%;margin-right:5px;}
#inputArea{display:flex;padding:10px;background:white;border-radius:25px;margin:10px;align-items:center;position:relative;}
#inputArea input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;}
#inputArea button{margin-left:5px;padding:10px 12px;border:none;border-radius:50%;background:#25d366;color:white;cursor:pointer;}
#popup{display:none;position:absolute;bottom:50px;right:15px;background:white;padding:10px;border-radius:10px;box-shadow:0 0 5px #888;flex-direction:column;}
#popup button{margin:3px;padding:8px;border:none;border-radius:6px;background:#128C7E;color:white;cursor:pointer;}
#topAdd{position:absolute;right:10px;top:10px;cursor:pointer;font-size:20px;background:white;color:#25d366;border-radius:6px;padding:3px 6px;}
</style>
</head>
<body>

<div class="header">
  <h2 id="groupName"></h2>
  <img id="groupPhoto" src="">
  <div id="members"></div>
  <div id="topAdd">Add</div>
</div>

<div id="chatBox"></div>

<div id="inputArea">
  <input id="msgInput" placeholder="Type a message...">
  <button id="sendBtn">‚û§</button>
  <button id="plusBtn">+</button>
  <div id="popup">
    <button onclick="sendFile()">üìé File</button>
    <button onclick="sendPhoto()">üñºÔ∏è Photo</button>
    <button onclick="sendVideo()">üé• Video</button>
    <button onclick="sendLocation()">üìç Location</button>
    <button onclick="alert('Voice call coming soon')">üìû Call</button>
    <button onclick="alert('Video call coming soon')">üé• Video Call</button>
  </div>
</div>

<script>
let groups = JSON.parse(localStorage.getItem("groups")||"[]");
let currentIndex = localStorage.getItem("currentGroupIndex");
let group = groups[currentIndex];
const myName="You";

document.getElementById("groupName").innerText = group.name;
document.getElementById("groupPhoto").src = group.photo;

// Mark group as read on open
if(group.unread){ group.unread=false; saveGroup(); }

// Change group name/photo
document.getElementById("groupName").onclick = ()=>{
  const newName = prompt("Enter new group name:", group.name);
  if(newName) { group.name=newName; saveGroup(); document.getElementById("groupName").innerText=newName;}
};

document.getElementById("groupPhoto").onclick = ()=>{
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = event => {
        group.photo = event.target.result;
        saveGroup();
        document.getElementById("groupPhoto").src = group.photo;
      }
      reader.readAsDataURL(file);
    }
  };
  fileInput.click();
};

// Render members
function renderMembers(){
  const div=document.getElementById("members");
  div.innerHTML="";
  group.members.filter(m=>m.accepted).forEach(m=>{
    const mDiv=document.createElement("div");
    mDiv.textContent=m.name;

    if(group.admin===myName && m.name!==myName){
      const blockSpan=document.createElement("span");

      // üö´ if blocked, ‚≠ï if unblocked
      blockSpan.textContent = group.blocked.includes(m.name) ? "üö´" : "‚≠ï";

      blockSpan.onclick=()=>blockMember(m.name);
      mDiv.appendChild(blockSpan);
    }
    div.appendChild(mDiv);
  });
}

function blockMember(name){
  if(group.blocked.includes(name)){
    // Unblock
    group.blocked=group.blocked.filter(x=>x!==name);
  } else {
    // Block
    group.blocked.push(name);
  }
  saveGroup();
  renderMembers();
  renderMessages();
  checkBlockedStatus();
}

// Chat messages
const chatBox=document.getElementById("chatBox");
function renderMessages(){
  chatBox.innerHTML="";
  group.messages.forEach(m=>{
    // Hide messages from blocked users
    if(group.blocked.includes(m.sender)) return;
    const div=document.createElement("div");
    div.className="msg"+(m.sender===myName?" self":"");
    div.innerHTML=`<img src="profile.png"><strong>${m.sender}:</strong> ${m.text}`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}

document.getElementById("sendBtn").onclick=()=>{
  const txt=document.getElementById("msgInput").value.trim();
  if(!txt) return;
  if(group.blocked.includes(myName)){ return; } // can't send while blocked
  group.messages.push({sender:myName,text:txt});
  group.unread = false; // your messages don‚Äôt trigger unread
  document.getElementById("msgInput").value="";
  saveGroup();
  renderMessages();
}

// Disable/enable input if user blocked
function checkBlockedStatus() {
  const input = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");

  if (group.blocked.includes(myName)) {
    input.disabled = true;
    input.placeholder = "‚ùå You are blocked";
    sendBtn.disabled = true;
    sendBtn.style.opacity = "0.5";
    sendBtn.style.cursor = "not-allowed";
  } else {
    input.disabled = false;
    input.placeholder = "Type a message...";
    sendBtn.disabled = false;
    sendBtn.style.opacity = "1";
    sendBtn.style.cursor = "pointer";
  }
}

// Add or delete group
document.getElementById("topAdd").onclick = ()=>{
  const action = prompt("Type 'add' to add user or 'delete' to delete group:");
  if(action==="add"){
    const name=prompt("Friend name to add:");
    if(name){
      group.members.push({name,accepted:true});
      saveGroup(); renderMembers(); alert(name+" added.");
    }
  } else if(action==="delete"){
    if(confirm("Are you sure you want to delete this group?")){
      groups.splice(currentIndex,1);
      localStorage.setItem("groups",JSON.stringify(groups));
      alert("Group deleted");
      window.location.href="groups.html";
    }
  }
}

// Plus button for file/photo/video/location/call
const plusBtn = document.getElementById("plusBtn");
const popup = document.getElementById("popup");
plusBtn.onclick = ()=> popup.style.display = popup.style.display==="flex"?"none":"flex";

// File/photo/video/location placeholders
function sendFile(){ group.messages.push({sender:myName,text:"[Sent File]"}); saveGroup(); renderMessages();}
function sendPhoto(){ group.messages.push({sender:myName,text:"[Sent Photo]"}); saveGroup(); renderMessages();}
function sendVideo(){ group.messages.push({sender:myName,text:"[Sent Video]"}); saveGroup(); renderMessages();}
function sendLocation(){ group.messages.push({sender:myName,text:"[Sent Location]"}); saveGroup(); renderMessages();}

function saveGroup(){
  groups[currentIndex]=group;
  localStorage.setItem("groups",JSON.stringify(groups));
}

renderMembers();
renderMessages();
checkBlockedStatus();
</script>
</body>
</html>
