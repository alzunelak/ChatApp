<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Join Group</title>
<style>
body {
  font-family: Arial;
  background: #ece5dd;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px #888;
  text-align: center;
  width: 90%;
  max-width: 400px;
}
button {
  padding: 10px 15px;
  border: none;
  border-radius: 6px;
  background: #25d366;
  color: white;
  cursor: pointer;
  margin-top: 10px;
}
input {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 90%;
  margin-top: 10px;
}
</style>
</head>
<body>

<div class="container">
  <h2 id="groupName"></h2>
  <p id="message"></p>
  <input id="userName" placeholder="Enter your name">
  <br>
  <button id="joinBtn">Join Group</button>
</div>

<script>
// Read URL parameters
const urlParams = new URLSearchParams(window.location.search);
const groupNameParam = urlParams.get("group");
const invitedUserParam = urlParams.get("user");

// Load groups from localStorage
let groups = JSON.parse(localStorage.getItem("groups") || "[]");
let groupIndex = groups.findIndex(g => g.name === groupNameParam);

const groupNameEl = document.getElementById("groupName");
const messageEl = document.getElementById("message");
const userNameInput = document.getElementById("userName");
const joinBtn = document.getElementById("joinBtn");

if (groupIndex === -1) {
  // Group not found
  groupNameEl.innerText = "Group not found";
  messageEl.innerText = "Invalid or expired link.";
  joinBtn.style.display = "none";
} else {
  const group = groups[groupIndex];
  groupNameEl.innerText = group.name;

  // Prefill invited username if present in URL
  if (invitedUserParam) {
    userNameInput.value = invitedUserParam;
    userNameInput.disabled = true; // prevent changing
  }

  joinBtn.onclick = () => {
    const name = userNameInput.value.trim();
    if (!name) { alert("Enter your name"); return; }

    // Check if invited
    if (!group.invited.includes(name) && group.admin !== name) {
      alert("You are not invited to this group!");
      return;
    }

    // Add member if not already in the group
    if (!group.members.find(m => m.name === name)) {
      group.members.push({ name, accepted: true });
    }

    // Set first member as admin if none
    if (!group.admin) group.admin = name;

    // Remove from invited list
    group.invited = group.invited.filter(u => u !== name);

    // Save changes
    groups[groupIndex] = group;
    localStorage.setItem("groups", JSON.stringify(groups));
    localStorage.setItem("currentGroupIndex", groupIndex);

    alert(`Welcome ${name}! You joined ${group.name}`);
    window.location.href = "group.html"; // redirect to group chat
  };
}
</script>

</body>
</html>
